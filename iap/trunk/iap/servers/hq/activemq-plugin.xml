<?xml version="1.0"?>

<!DOCTYPE plugin [
  <!ENTITY jvm-jmx-metrics SYSTEM "/pdk/plugins/jvm-jmx-metrics.xml">
  <!ENTITY process-metrics SYSTEM "/pdk/plugins/process-metrics.xml">
]>

<plugin package="org.hyperic.hq.plugin.activemq" name="activemq">

	<classpath>
		<include name="pdk/lib/mx4j" />
	</classpath>

	<filter name="domain" value="org.apache.activemq" />

	<filter name="template" value="${OBJECT_NAME}:${alias}" />

	<filter name="QUEUE_OBJECT_NAME" value="${domain}:Type=Queue,BrokerName=*,Destination=*" />
	<filter name="TOPIC_OBJECT_NAME" value="${domain}:Type=Topic,BrokerName=*,Destination=*" />
	<filter name="BROKER_OBJECT_NAME" value="${domain}:Type=Broker,BrokerName=*" />

	<metrics name="ActiveMQ 5.x Topic">
		<metric name="Availability" template="${TOPIC_OBJECT_NAME}:${alias}" indicator="true" />

		<metric name="Enqueue Count" template="${TOPIC_OBJECT_NAME}:${alias}" indicator="true" collectionType="trendsup"
			rate="1s" />
		<metric name="Dequeue Count" template="${TOPIC_OBJECT_NAME}:${alias}" indicator="true" collectionType="trendsup"
			rate="1s" />

		<metric name="Queue Size" template="${TOPIC_OBJECT_NAME}:${alias}" indicator="true" />
		<metric name="InFlight Count" template="${QUEUE_OBJECT_NAME}:${alias}" />
		<metric name="Expired Count" template="${QUEUE_OBJECT_NAME}:${alias}" />

		<metric name="Cursor Percent Usage" template="${QUEUE_OBJECT_NAME}:${alias}" units="percent" />
		<metric name="Memory Limit" template="${QUEUE_OBJECT_NAME}:${alias}" units="B" collectionType="static" />
		<metric name="Memory Percent Usage" template="${QUEUE_OBJECT_NAME}:${alias}" units="percent" />

		<metric name="Consumer Count" template="${TOPIC_OBJECT_NAME}:${alias}" />
		<metric name="Producer Count" template="${QUEUE_OBJECT_NAME}:${alias}" />
	</metrics>

	<metrics name="ActiveMQ 5.x Queue">
		<metric name="Availability" template="${QUEUE_OBJECT_NAME}:${alias}" indicator="true" />

		<metric name="Enqueue Count" template="${QUEUE_OBJECT_NAME}:${alias}" indicator="true" rate="1s"
			collectionType="trendsup" />
		<metric name="Dequeue Count" template="${QUEUE_OBJECT_NAME}:${alias}" indicator="true" rate="1s"
			collectionType="trendsup" />

		<metric name="Queue Size" template="${QUEUE_OBJECT_NAME}:${alias}" indicator="true" />
		<metric name="InFlight Count" template="${QUEUE_OBJECT_NAME}:${alias}" />
		<metric name="Expired Count" template="${QUEUE_OBJECT_NAME}:${alias}" />

		<metric name="Cursor Percent Usage" template="${QUEUE_OBJECT_NAME}:${alias}" units="percent" />
		<metric name="Memory Limit" template="${QUEUE_OBJECT_NAME}:${alias}" units="B" collectionType="static" />
		<metric name="Memory Percent Usage" template="${QUEUE_OBJECT_NAME}:${alias}" units="percent" />

		<metric name="Consumer Count" template="${QUEUE_OBJECT_NAME}:${alias}" />
		<metric name="Producer Count" template="${QUEUE_OBJECT_NAME}:${alias}" />
	</metrics>

	<metrics name="ActiveMQ 5.x Broker">
		<metric name="Availability" template="${BROKER_OBJECT_NAME}:${alias}" indicator="true" />

		<metric name="Total Consumer Count" template="${BROKER_OBJECT_NAME}:${alias}" />
		<metric name="Total Enqueue Count" template="${BROKER_OBJECT_NAME}:${alias}" indicator="true" collectionType="trendsup"
			rate="1s" />
		<metric name="Total Dequeue Count" template="${BROKER_OBJECT_NAME}:${alias}" indicator="true" collectionType="trendsup"
			rate="1s" />
		<metric name="Total Message Count" template="${BROKER_OBJECT_NAME}:${alias}" indicator="true" collectionType="trendsup"
			rate="1s" />

		<metric name="Memory Limit" template="${BROKER_OBJECT_NAME}:${alias}" collectionType="static" units="B" />
		<metric name="Memory Percent Usage" template="${BROKER_OBJECT_NAME}:${alias}" units="percent" />
		<metric name="Store Limit" template="${BROKER_OBJECT_NAME}:${alias}" collectionType="static" units="B" />
		<metric name="Store Percent Usage" template="${BROKER_OBJECT_NAME}:${alias}" units="percent" />
		<metric name="Temp Limit" template="${BROKER_OBJECT_NAME}:${alias}" collectionType="static" units="B" />
		<metric name="Temp Percent Usage" template="${BROKER_OBJECT_NAME}:${alias}" units="percent" />
	</metrics>

	<config name="destination">
		<option name="BrokerName" description="Broker Name" default="" />
		<option name="Destination" description="Destination" default="" />
	</config>

	<server name="ActiveMQ" version="5.x">

		<!-- derive installpath from -Dactivemq.home=... -->
		<property name="PROC_HOME_PROPERTY" value="activemq.home" />
		<property name="VERSION_FILE" value="lib/activemq-core-5.*.jar" />

		<property name="HAS_BUILTIN_SERVICES" value="true" />
		<property name="DEFAULT_LOG_FILE" value="var/activemq.log" />
		<property name="DEFAULT_CONF" value="conf/activemq.xml" />

		<config include="jmx">
			<option name="process.query" description="Process Query" default="State.Name.eq=java,Args.*.ct=org.apache.activemq" />
		</config>

		<plugin type="autoinventory" class="org.hyperic.hq.product.jmx.MxServerDetector" />
		<plugin type="measurement" class="org.hyperic.hq.product.jmx.MxMeasurementPlugin" />
		<plugin type="log_track" class="org.hyperic.hq.product.Log4JLogTrackPlugin" />
		<plugin type="config_track" class="org.hyperic.hq.product.ConfigFileTrackPlugin" />

		<metric name="Availability" template="sigar:Type=ProcState,Arg=%process.query%:State" indicator="true" />

    	&process-metrics;

    	&jvm-jmx-metrics;

		<service name="Broker">
			<property name="OBJECT_NAME" value="${BROKER_OBJECT_NAME}" />

			<config>
				<option name="BrokerName" description="Broker Name" default="" />
			</config>

			<plugin type="autoinventory" />

			<plugin type="control" class="org.hyperic.hq.product.jmx.MxControlPlugin" />
			<actions include="start,stop,gc,removeTopic,removeQueue" />
		</service>

		<service name="Queue">
			<property name="OBJECT_NAME" value="${QUEUE_OBJECT_NAME}" />

			<config include="destination" />

			<plugin type="autoinventory" />

			<plugin type="control" class="org.hyperic.hq.product.jmx.MxControlPlugin" />
			<actions include="sendTextMessage" />
		</service>

		<service name="Topic">
			<property name="OBJECT_NAME" value="${TOPIC_OBJECT_NAME}" />

			<config include="destination" />

			<plugin type="autoinventory" />

			<plugin type="control" class="org.hyperic.hq.product.jmx.MxControlPlugin" />
			<actions include="sendTextMessage" />
		</service>
	</server>

	<server name="ActiveMQ Embedded" version="5.x" include="ActiveMQ 5.x">
		<property name="PROC_HOME_PROPERTY" value="catalina.base" />
		<plugin type="autoinventory" class="org.hyperic.hq.plugin.activemq.EmbeddedActiveMQServerDetector" />
	</server>
</plugin>
