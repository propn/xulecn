var Const = {
	Tuesday : "\u4E8C",
	Sunday : "\u65E5",
	Wednesday : "\u4E09",
	ErrTypeNumber : "\u60A8\u8F93\u5165\u7684\u503C[%s]\u4E0D\u662F\u4E00\u4E2A\u6709\u6548\u7684\u6570\u5B57\uFF01",
	ErrAddField : "\u60A8\u4E0D\u80FD\u5BF9\u5DF2\u5B8C\u6210\u521D\u59CB\u5316\u7684\u8BB0\u5F55\u96C6\u6DFB\u52A0\u5B57\u6BB5\uFF01",
	DatasetPrevPage : "\u5411\u524D\u7FFB\u9875",
	LastMonth : "\u4E0A\u4E2A\u6708",
	ErrType : "\u9519\u8BEF\u7C7B\u578B",
	ErrDownLoadFailed : "\u4E0B\u8F7D\u6570\u636E\u5931\u8D25\uFF01",
	ErrInputMask : "\u60A8\u8F93\u5165\u4E86\u7684\u503C[%s]\u4E0D\u7B26\u5408\u8BE5\u5B57\u6BB5\u7684\u6821\u9A8C\u89C4\u5219\uFF01",
	LastYear : "\u4E0A\u4E00\u5E74",
	ErrTypeInt : "\u60A8\u8F93\u5165\u7684\u503C[%s]\u4E0D\u662F\u4E00\u4E2A\u6709\u6548\u7684\u6574\u6570\uFF01",
	ErrTypeDouble : "\u4f60\u8f93\u5165\u7684\u5c0f\u6570[%s]\u4e0d\u6b63\u786e",
	ErrTypeMoney : "\u4f60\u8f93\u5165\u7684[%s]\u4e0d\u662f\u4e00\u4e2a\u6709\u6548\u7684\u8d37\u5e01\u503c",
	BtnUpdateRecord : "\u786E\u8BA4",
	ErrTypeTime : "\u60A8\u8F93\u5165\u7684\u503C[%s]\u4E0D\u662F\u4E00\u4E2A\u6709\u6548\u7684\u65F6\u95F4\u578B\u503C\uFF01",
	BtnEditRecord : "\u4FEE\u6539",
	ErrEmptyFieldName : "\u5B57\u6BB5\u540D\u4E0D\u80FD\u4E3A\u7A7A\uFF01",
	ErrTypeDateTime : "\u60A8\u8F93\u5165\u7684\u503C[%s]\u4E0D\u662F\u4E00\u4E2A\u6709\u6548\u7684\u65E5\u671F+\u65F6\u95F4\u578B\u503C\uFF01",
	BtnDeleteRecord : "\u5220\u9664",
	BtnCancelRecord : "\u64A4\u9500",
	DatasetMovePrev : "\u79FB\u52A8\u5230\u4E0A\u4E00\u6761\u8BB0\u5F55",
	DatasetConfirmDelete : "\u60A8\u786E\u5B9A\u8981\u5220\u9664\u5F53\u524D\u8BB0\u5F55\u5417\uFF1F",
	DownLoadingData : "\u6B63\u5728\u4E0B\u8F7D\u6570\u636E...",
	ErrLoadPageOnDetailDataset : "\u5DF2\u5EFA\u7ACB\u4E3B\u4ECE\u7ED1\u5B9A\u7684\u4ECE\u8868\u8BB0\u5F55\u96C6\u4E0D\u80FD\u6267\u884C\u5206\u6279\u4E0B\u8F7D\uFF01",
	DatasetCancelRecord : "\u64A4\u9500\u5BF9\u5F53\u524D\u8BB0\u5F55\u7684\u4FEE\u6539",
	DatasetMoveFirst : "\u79FB\u52A8\u5230\u7B2C\u4E00\u6761\u8BB0\u5F55",
	ErrNoCurrentRecord : "\u7531\u4E8E\u8BB0\u5F55\u96C6\u6CA1\u6709\u5F53\u524D\u8BB0\u5F55\u800C\u65E0\u6CD5\u4FEE\u6539\u5B57\u6BB5\u503C\uFF01",
	CancelSort : "\u4E0D\u6392\u5E8F",
	ErrKeyFieldRequired : "\u6CA1\u6709\u5B9A\u4E49\u4E3B\u952E\u5B57\u6BB5\uFF01",
	ErrNoMasterRecord : "\u7531\u4E8E\u4E3B\u8BB0\u5F55\u96C6\u6CA1\u6709\u5F53\u524D\u8BB0\u5F55\u800C\u65E0\u6CD5\u6DFB\u52A0\u660E\u7EC6\uFF01",
	ErrUpdateFailed : "\u4FDD\u5B58\u6570\u636E\u5931\u8D25\uFF01",
	DatasetInsertRecord : "\u63D2\u5165\u4E00\u6761\u65B0\u8BB0\u5F55",
	ErrDescription : "\u9519\u8BEF\u63CF\u8FF0",
	BtnAppendRecord : "\u6DFB\u52A0",
	ErrFieldValueRequired : "\u5B57\u6BB5[%s]\u7684\u5185\u5BB9\u4E0D\u80FD\u4E3A\u7A7A\uFF01",
	DatasetAppendRecord : "\u6DFB\u52A0\u4E00\u6761\u65B0\u8BB0\u5F55",
	Saturday : "\u516D",
	ErrUnsupportBrowser : "\u7531\u4E8E\u60A8\u4F7F\u7528\u7684\u4E0D\u662F Microsoft Internet Explorer 5.0 \u6216\u66F4\u9AD8\u7248\u672C\u7684\u6D4F\u89C8\u5668\uFF0C\u60A8\u5C06\u6709\u53EF\u80FD\u65E0\u6CD5\u83B7\u5F97\u672C\u9875\u9762\u6B63\u786E\u7684\u663E\u793A\u7ED3\u679C\uFF01/n\u8BF7\u5347\u7EA7\u60A8\u7684\u6D4F\u89C8\u5668\u3002",
	Friday : "\u4E94",
	ErrLoadPageAfterSort : "\u5DF2\u8FDB\u884C\u5BA2\u6237\u7AEF\u6392\u5E8F\u7684\u8BB0\u5F55\u96C6\u4E0D\u80FD\u6267\u884C\u5206\u6279\u4E0B\u8F7D\uFF01",
	DatasetMoveLast : "\u79FB\u52A8\u5230\u6700\u540E\u4E00\u6761\u8BB0\u5F55",
	Today : "\u4ECA\u5929",
	NextMonth : "\u4E0B\u4E2A\u6708",
	ErrCantFindField : "\u627E\u4E0D\u5230\u6307\u5B9A\u7684\u5B57\u6BB5[%s]\uFF01",
	ErrTypeDate : "\u60A8\u8F93\u5165\u7684\u503C[%s]\u4E0D\u662F\u4E00\u4E2A\u6709\u6548\u7684\u65E5\u671F\u578B\u503C\uFF01",
	ErrCantFindMasterField : "\u4E3B\u8868\u5B57\u6BB5[%s]\u4E0D\u5B58\u5728\uFF01",
	ErrCantFindDetailField : "\u4ECE\u8868\u5B57\u6BB5[%s]\u4E0D\u5B58\u5728\uFF01",
	Thursday : "\u56DB",
	DatasetMoveNext : "\u79FB\u52A8\u5230\u4E0B\u4E00\u6761\u8BB0\u5F55",
	DatasetNextPage : "\u5411\u540E\u7FFB\u9875",
	DatasetEditRecord : "\u4FEE\u6539\u5F53\u524D\u8BB0\u5F55",
	Monday : "\u4E00",
	ErrUnknown : "\u672A\u77E5\u9519\u8BEF\uFF01",
	ErrUpdateFieldRequired : "\u6CA1\u6709\u53EF\u66F4\u65B0\u7684\u5B57\u6BB5\uFF01",
	ErrOutOfDropDownList : "\u60A8\u8F93\u5165\u4E86\u65E0\u6548\u7684\u503C\uFF01",
	DatasetDeleteRecord : "\u5220\u9664\u5F53\u524D\u8BB0\u5F55",
	DatasetUpdateRecord : "\u786E\u8BA4\u5BF9\u5F53\u524D\u8BB0\u5F55\u7684\u4FEE\u6539",
	NextYear : "\u4E0B\u4E00\u5E74",
	DatasetConfirmCancel : "\u60A8\u786E\u5B9A\u8981\u64A4\u6D88\u5BF9\u5F53\u524D\u8BB0\u5F55\u7684\u4FEE\u6539\u5417\uFF1F",
	BtnInsertRecord : "\u63D2\u5165"
}

Control = {

	documentInitialized : false,

	before_Page_onLoad : true,

	processingPropertyDataset : false,

	processingRelaDataset : false,

	initElementDataset : function(element) {
		var dataset = element.getAttribute("dataset");
		if (dataset) {
			Dataset.setElementDataset(element, dataset);
		}
	},

	initDocument : function() {

		if (Global.onServer) {
			var forms = document.getElementsByTagName("FORM");
			if (forms) {
				var forms_length = forms.length;
				for (var i = 0; i < forms_length; i++) {
					// var startDate = new Date();
					var editors = forms[i].elements;
					if (editors) {
						var editors_length = editors.length;
						for (var j = 0; j < editors_length; j++) {
							var editor = editors[j];
							if (editor && editor.tagName
									&& editor.tagName != "BUTTON"
									&& editor.className
									&& editor.className == "editor") {
								editor.extra = "editor";
								initEditor(editor);
							}
						}
					}
					// var time = ((new Date())-startDate);
					// jsDebug.debug("... form : "+forms[i].id+" : "+time);
				}
			}
		}
		var pilots = Document.array_pilot;
		if (pilots) {
			var pilots_length = pilots.length;
			for (var i = 0; i < pilots_length; i++) {
				var pilot = pilots[i];
				if (pilot) {
					pilot.initial();
				}
			}
		}
		// var startDateF = new Date();
		freshDatasetControls();
		// jsDebug.debug("...freshDatasetControls : : "+((new
		// Date())-startDateF));
		Control.documentInitialized = true;
		// var startDateF = new Date();
		freshDatasetControls2();
		// jsDebug.debug("...freshDatasetControls : : "+((new
		// Date())-startDateF));

		Control.before_Page_onLoad = false;

		Document.fireUserEvent("page_onLoad", []);

		if (typeof(Editor.sizeDockEditor) != "undefined")
			Control.adjustControlsSize();

		if (typeof(document.activeElement) != "unknown") {
			Document.activeElement = null;
			Document.processActiveElementChanged(document.activeElement);
		}

		// for i18n 运行
		// if(eval(initClientI18N)!= undefined ){initClientI18N();}

		displayError();

	},

	uninitElement : function(element) {

		var _extra = "";

		if (element.extra != null && element.extra != "")
			_extra = element.extra;
		else if (element.className != null && element.className != "")
			_extra = element.className;

		switch (_extra) {
			case "datatable" : {
				element.activeRow = null;
				element.activeCell = null;
				element._activeCell = null;
				element.hoverRow = null;
				element.repeatRow = null;
			}
			case "datalabel" :
				;
			case "editor" :
				;
			case "dockeditor" :
				;
			case "tablecell" :
				;
			case "tablerow" :
				;
			case "pagepilot" :
				;
			case "datapilot" :
				;
			case "coolButton" :
				;
			case "customerpilot" : {
				if (typeof(Dataset.setElementDataset) != "undefined")
					Dataset.setElementDataset(element, null);
				if (typeof(element.dataset) != "undefined")
					element.dataset = null;
				if (typeof(element.record) != "undefined")
					element.record = null;
				if (typeof(element.field) != "undefined")
					element.field = null;
				if (typeof(element.dropDown) != "undefined")
					element.dropDown = null;
				if (typeof(element.table) != "undefined")
					element.table = null;
				if (typeof(element.editor) != "undefined")
					element.editor = null;
				if (typeof(element.window) != "undefined")
					element.window = null;
				if (typeof(element.datapilot) != "undefined")
					element.datapilot = null;
				if (typeof(element.pilot) != "undefined")
					element.pilot = null;

				if (typeof(element.onmousedown) != "undefined")
					element.onmousedown = null;
				if (typeof(element.onmouseover) != "undefined")
					element.onmouseover = null;
				if (typeof(element.onmouseout) != "undefined")
					element.onmouseout = null;
				if (typeof(element.onkeydown) != "undefined")
					element.onkeydown = null;
				if (typeof(element.onclick) != "undefined")
					element.onclick = null;
				if (typeof(element.ondblclick) != "undefined")
					element.ondblclick = null;
				if (typeof(element.onkeypress) != "undefined")
					element.onkeypress = null;
				if (typeof(element.onpropertychange) != "undefined")
					element.onpropertychange = null;
				break;
			}
		}
	},

	uninitElements : function(element) {

		if (!element)
			element = document.body;
		if (element) {
			for (var i = 0; i < element.children.length; i++) {
				Control.uninitElements(element.children[i]);
			}
			Control.uninitElement(element);
		}

	},

	disableAllElements : function() {

		var datasets = Document.array_dataset;
		if (datasets) {
			for (var i = 0; i < datasets.length; i++) {
				datasets[i].setReadOnly(true);
				datasets[i].setPopupEnable(false);
			}
		}

		var tables = document.getElementsByTagName("TABLE");
		if (tables) {
			for (var i = 0; i < tables.length; i++) {
				var table = tables[i];
				if (table.className == "datatable") {
					table.setReadOnly(true);
					table.setEditable(false);
				}
			}
		}
	},

	adjustControlsSize : function() {
		if (typeof(Editor.sizeDockEditor) != "undefined") {
			Editor.sizeDockEditor();
			if (typeof(Dropdown.sizeDropDownBtn) != "undefined"
					&& Document.activeEditor)
				Dropdown.sizeDropDownBtn(Document.activeEditor);
			if (typeof(Dropdown.sizeDropDownBox) != "undefined")
				Dropdown.sizeDropDownBox();
		}
	},

	getElementDataset : function(element) {
		switch (element.getAttribute("extra")) {
			case "tablecell" : {
				return element.dataset;
				break;
			}
			case "tablerow" : {
				return element.record.dataset;
				break;
			}
			case "dockeditor" : {
				var holder = element.editorHolder;
				if (holder) {
					return Control.getElementDataset(holder);
				}
				break;
			}
			default : {
				return element.getAttribute("dataset");
				break;
			}
		}
	},

	getElementField : function(element) {
		var dataset = Control.getElementDataset(element);
		if (!dataset)
			return;
		return dataset.getField(element.getAttribute("field"));
	},

	getElementValue : function(element) {
		switch (element.getAttribute("extra")) {
			case "editor" :
				;
			case "dockeditor" : {
				switch (element.type) {
					case "checkbox" : {
						return element.checked;
						break;
					}
					default : {
						var result = element.value;
						var _dropdown = Editor.getEditorDropDown(element);
						if (_dropdown) {
							if (_dropdown.type == "list") {

								var items = Dropdown
										.getDropDownItems(_dropdown);
								if (items) {
									var item = items.find(["label"], [System
													.trimStr(element.value)]);
									if (item)
										result = item.getString("value");
								}
							}
						}
						return result;
						break;
					}
				}
				break;
			}

			default : {
				return element.value;
				break;
			}
		}
	},

	setElementValue : function(element, value) {

		function getEditorValue(element, value) {
			var result;
			switch (typeof(value)) {
				case "string" :
					result = System.getValidStr(value);
					var _dropdown = Editor.getEditorDropDown(element);
					if (_dropdown) {
						if (_dropdown.type == "list") {
							result = "";
							var items = Dropdown.getDropDownItems(_dropdown);
							var parentValueId = null;
							if (items) {
								var item = items.find(["value"], [System
												.trimStr(value)]);
								if (item) {
									result = item.getString("label");
									parentValueId = item.getString("valueId");
								} else {
									var dataset = Control
											.getElementDataset(element);
									if (dataset && !dataset.readOnly) {
										if (element.getAttribute("extra") == "editor") {
											var record = items.getFirstRecord();
											if (record) {
												result = record
														.getValue("label");
												parentValueId = record
														.getValue("valueId");
												if (dataset.getCurrent()) {
													dataset
															._setValue(
																	element.field,
																	record
																			.getValue("value"));
												}
											}
										}
									} else {
										result = "";
									}
								}
							}
							if ((element.subList != undefined)
									&& element.subList != ""
									&& (document
											.getElementById(element.subList))
									&& (element.dataset != (document
											.getElementById(element.subList)).dataset)) {
								// 如果没有记录时，设置一个没有存在的parentValueId
								if (parentValueId == null
										|| parentValueId == "")
									parentValueId = "__1";
							}
							if ("DC_SUB_EXCH_ID" == element.dropDown) {
								if (parentValueId == null
										|| parentValueId == "")
									parentValueId = "__1";
							}
							// 如果有subList属性，则更新subEditor。并且递归遍历。
							if ((element.subList != undefined)
									&& element.subList != ""
									&& (document
											.getElementById(element.subList) != null)
									&& parentValueId != null) {
								var subEditor = document
										.getElementById(element.subList);
								var subDropdown = Editor
										.getEditorDropDown(subEditor);

								// if(!subDropdown.getAttribute("secondTime")){
								// gensoinfo.jsp特殊处理
								if (typeof(gensoinfo) != "undefined"
										&& ((element.field == "lanId"
												|| element.field == "businessId"
												|| element.field == "dealExchId"
												|| element.field == "masterExchId" || element.field == "subExchId") || (element.field == "zLanId"
												|| element.field == "zBusinessId"
												|| element.field == "zDealExchId"
												|| element.field == "zMasterExchId" || element.field == "zSubExchId"))) {
									// 最后一级有关联
									if ("DC_SUB_EXCH_ID" == element.dropDown) {
										Editor.setSubEditor(element,
												parentValueId);
									}
									// nothing-todo
								} else {
									Editor.setSubEditor(element, parentValueId);
								}
								// subDropdown.setAttribute("secondTime", true);
								// }
							}

						} else if (_dropdown.type == "date") {
							if (result == "") {
								var dataset = Control
										.getElementDataset(element);
								if (dataset && !dataset.readOnly) {
									if (dataset.getCurrent()) {
										var defaultValue = dataset
												.getField(element.field).defaultValue;
										if (defaultValue && defaultValue != "") {
											if (defaultValue == "today") {
												result = formatDate(new Date(),
														"yyyy-MM-dd");
											} else if (defaultValue == "firstDateOfThisMonth") {
												result = formatDate(
														new Date(
																new Date()
																		.getYear(),
																new Date()
																		.getMonth(),
																1),
														"yyyy-MM-dd");
											}
											dataset._setValue(element.field,
													result);
											dataset.getField(element.field).defaultValue = "";
										}
									}
								}
							}
						} else {
							// 回显下拉表格对应的描述数据
							if (_dropdown.dataset && value == "") {

								var dataset = Dataset
										.getDatasetByID(_dropdown.dataset);

								if (dataset) {
									var field = dataset.getField(element.field)
											.getName();

									var keyField = element.dataset
											.getField(element.field).keyField;

									if (element.tagName == "TD") {
										var row = Table.getRowByCell(element);
										if (row && row.record) {
											var keyValue = row.record
													.getValue(keyField);
											var record = dataset.locate(
													keyField, keyValue);

											if (record)
												result = record.getValue(field);
										}
									} else if (element.tagName == "INPUT") {
										if (element.dataset) {
											var keyValue = element.dataset
													.getValue(keyField);
											var record = dataset.locate(
													keyField, keyValue);

											if (record)
												result = record.getValue(field);
										}
									}
								}
							}
						}
					}
					break;
				default :
					result = value;
					break;
			}
			return result;
		}

		switch (element.getAttribute("extra")) {
			case "fieldlabel" : {
				var eventName = Document.getElementEventName(element,
						"onRefresh");
				if (Document.isUserEventDefined(eventName)) {
					if (!Document.fireUserEvent(eventName, [element, value]))
						break;
				}
				if (element.indicator && element.indicator != "")
					element.innerHTML = value + element.indicator;
				else
					element.innerHTML = value;
				break;
			}
			case "editor" :
				;
			case "dockeditor" : {
				if (element.oldValue == value && !element.modified)
					return;

				element.keyValue = value;
				switch (element.type) {
					case "checkbox" : {
						element.checked = System.isTrue(value);
						break;
					}
					default : {
						element.value = getEditorValue(element, value);
						var dataset = element.dataset;
						if (value != "" && dataset && dataset.maskControl) {
							if (element.type != "password") {
								if (dataset.isFieldMaskControl(element.field)) {
									element.value = "######";
								}
							}
						}

						element.keyValue = value;
						break;
					}
				}

				break;
			}

			case "columnheader" : {
				element.innerHTML = value;
				break;
			}

			case "tablecell" : {
				var table = Table.getTableByCell(element);
				var eventName = table.id + "_" + element.name + "_onRefresh";
				if (Document.isUserEventDefined(eventName)) {
					var record = Datatable.getRecordByCell(element);
					if (record
							&& !Document.fireUserEvent(eventName, [element,
											value, record]))
						break;
				}

				if (element.getAttribute("name") == "select") {
					var record = Datatable.getRecordByCell(element);
					if (record) {
						if (System.isTrue(record.getValue("select"))) {
							element.innerHTML = "<input type=checkbox checked onclick=\"return TableCheckbox.onclick();\" style=\"height:16\">";
						} else {
							element.innerHTML = "<input type=checkbox onclick=\"return TableCheckbox.onclick();\" style=\"height:16\">";
						}
					}
				} else {
					var tmpHTML;
					switch (element.getAttribute("editorType")) {
						case "checkbox" : {
							if (System.isTrue(value)) {
								tmpHTML = "<font face=Marlett size=2>a</font>";
							} else {
								tmpHTML = "<font face=Webdings size=1 color=silver>c</font>";
							}
							element.innerHTML = tmpHTML;
							break;
						}
						default : {
							tmpHTML = getEditorValue(element, value);// #################################

							var dataset = element.dataset;
							if (tmpHTML != ""
									&& dataset
									&& dataset
											.isFieldMaskControl(element.field)) {
								element.innerText = "######";
							} else {
								if (tmpHTML != ""
										&& element.editorType == "password") {
									var passwordText = "";
									for (var i = 0; i < tmpHTML.length; i++) {
										passwordText += "*";
									}
									element.innerText = passwordText;
								} else {
									if (tmpHTML == "")
										tmpHTML = " ";
									element.innerText = tmpHTML;
								}
							}
						}
					}
				}
				break;
			}
			default : {
				element.value = value;
			}
		}
	},

	refreshElementValue : function(element) {
		var dataset;
		var _extra = element.getAttribute("extra");

		switch (_extra) {
			case "fieldlabel" : {
				var label = element.getAttribute("field");
				var field = Control.getElementField(element);
				if (field) {
					label = field.label;
					if (field.required && !field.readOnly
							&& !field.dataset.readOnly) {
						if (element.id != ""
								&& document.getElementById("_" + element.id)) {
							document.getElementById("_" + element.id).innerHTML = "<span class='require'>*</span>";
						} else {
							label = "<span class='require'>*</span>" + label;
						}
					}
				}
				Control.setElementValue(element, label);
				break;
			}
			case "columnheader" : {

				var label = System.getValidStr(element.getAttribute("label"));
				var field = Control.getElementField(element);

				if (!label) {
					if (field) {
						label = field.label;
					} else {
						label = System
								.getValidStr(element.getAttribute("name"));
					}
				}
				if (!label) {
					label = element.getAttribute("name");
				}

				if (field) {
					if (System.isTrue(field.required) && !field.readOnly
							&& !field.dataset.readOnly) {
						label = "<font color=red>*</font>" + label;
					}
				}

				Control.setElementValue(element, label);
				break;
			}

			case "tablecell" : {
				var row = Table.getRowByCell(element);
				var record = row.record;
				var dataField = element.getAttribute("field");

				if (record) {
					var s = record.getString(dataField);
					if (s.length > 120) {
						Control.setElementValue(element, s.substring(0, 120)
										+ "...");// ********************************
						element.title = s;
					} else {
						Control.setElementValue(element, s);// ********************************
						element.title = "";
					}
				} else
					Control.setElementValue(element, "");

				break;
			}
			default : {
				dataset = Control.getElementDataset(element);

				var value = "";
				if (dataset) {
					var fieldName = element.getAttribute("field");
					if (fieldName) {
						if ((_extra == "editor" || _extra == "dockeditor")
								&& Document.forEditor == element) {
							value = dataset.getValue(fieldName);
						} else {
							value = dataset.getString(fieldName);
						}
					}
					Control.setElementValue(element, value);
				}
				element.oldValue = Control.getElementValue(element);
				element.modified = false;
				break;
			}
		}
	}
}

Document = {
	// 当前激活元素
	activeElement : null,

	// 当前激活编辑器
	activeEditor : null,

	// 上一个激活编辑器
	forEditor : null,

	// 当前激活表格
	activeTable : null,

	// 是否为下拉框页面标识
	isDropDownPage : false,

	// 页面加载中标识
	loading : false,

	//
	stored_element : null,

	// 页面中的数据集
	array_dataset : [],
	array_pilot : [],

	// 页面中的xml数据岛列表
	xml_list : [],

	// ??????
	skip_activeChanged : false,

	// 自定义事件数组
	user_events : {},

	// 获取元素的某一事件的响应函数命名
	getElementEventName : function(element, eventName) {
		var result = "";
		if (element.extra != "dockeditor")
			result = element.id + "_" + eventName;
		else {
			var holder = element.editorHolder;
			if (holder)
				result = holder.id + "_" + eventName;
		}
		return result;
	},

	// 判断是否有某一事件的响应函数，
	// 如果已经访问的话，直接返回事件对象的defined属性
	// 如果还没有访问过的话，构造一个事件对象，并且缓存在事件数据当中
	// 判断该事件是否有响应函数，如果有设定defined属性为真（并且handle属性为函数名），否则为假
	isUserEventDefined : function(function_name) {
		if (function_name == "")
			return false;
		var eventInfo = Document.user_events[function_name];
		if (eventInfo == null) {
			eventInfo = {};
			Document.user_events[function_name] = eventInfo;
			var script = "eventInfo.defined=(typeof(" + function_name
					+ ")!=\"undefined\");"
					+ "if (eventInfo.defined) eventInfo.handle="
					+ function_name + ";";
			eval(script);
		}
		return eventInfo.defined;
	},

	// 触发某一自定义事件的响应函数
	fireUserEvent : function(function_name, param) {
		var result;

		if (function_name == "")
			return;
		var eventInfo = Document.user_events[function_name];
		if (eventInfo == null) {
			if (!Document.isUserEventDefined(function_name))
				return;
			eventInfo = Document.user_events[function_name];
		}

		if (eventInfo != null && eventInfo.defined) {
			result = eventInfo.handle(param[0], param[1], param[2], param[3]);
		}
		return result;
	},

	processActiveElementChanged : function(activeElement) {
		function isChildofTable(obj) {
			var result = null;
			var tmpObj;

			if (obj.getAttribute("extra") == "dockeditor")
				tmpObj = obj.editorHolder;
			else
				tmpObj = obj;

			if (tmpObj.getAttribute("extra") == "tablecell")
				result = Table.getTableByCell(tmpObj);
			return result;
		}

		function set_activeEditor(editor) {
			if (Document.activeEditor != editor) {
				if (Document.activeEditor) {
					if (Editor.needUpdateEditor) {
						if (Document.activeEditor.window == window)
							Editor.updateEditorInput(Document.activeEditor);
						else
							Document.activeEditor.window.Editor
									.updateEditorInput(Document.activeEditor);
					}
					if (typeof(Dropdown.hideDropDownBtn) != "undefined")
						Dropdown.hideDropDownBtn();
					switch (Document.activeEditor.getAttribute("extra")) {
						case "editor" : {
							Document.activeEditor.style.borderColor = "darkgray";
							break;
						}
						case "dockeditor" : {
							Editor.hideDockEditor(Document.activeEditor);
							break;
						}
					}
					Control.refreshElementValue(Document.activeEditor);
				}

				if (editor && !editor.readOnly) {
					var field = Control.getElementField(editor);
					if (editor.getAttribute("extra") == "editor"
							|| editor.getAttribute("extra") == "dockeditor") {
						// editor.className="editor_active";
						editor.style.borderColor = "#FFCC6A"; // dimgray
						if (field) {
							editor.dataType = field.dataType;
							editor.editorType = field.editorType;
						}

						if (!editor.getAttribute("dropDown")
								&& (editor.getAttribute("dataType") == "date"
										|| editor.getAttribute("dataType") == "datetime"
										|| editor.getAttribute("dataType") == "yearmonth" || editor
										.getAttribute("dataType") == "time")) {
							// 防止没有初始化日期
							makeCalendar();
							editor.dropDown = "dropDownDate";
						}
						if (editor.getAttribute("extra") == "editor" && field) {
							editor.maxLength = (field.size > 0)
									? field.size
									: 2147483647;
							if (field.size > 100
									&& System.compareText(editor.tagName,
											"TEXTAREA")
									&& !editor.getAttribute("dropDown")) {
								Document.stored_element = editor;
								editor.editorType = "textarea";
								setTimeout(
										"Editor.showDockEditor(Document.stored_element);",
										0);
							}
						}
					}
					Control.refreshElementValue(editor);

					if (typeof(Dropdown.showDropDownBtn) != "undefined") {
						Dropdown.showDropDownBtn(editor);
					}
					var _dropdown = Editor.getEditorDropDown(editor);
					if (_dropdown) {
						editor.contentEditable = (!System
								.isTrue(_dropdown.fixed));
						if (typeof(Dropdown.showDropDownBtn) != "undefined") {
							if (_dropdown
									&& System.isTrue(_dropdown.autoDropDown))
								Dropdown.showDropDownBox(editor);
						}
					} else {
						editor.contentEditable = true;
						// document.onselectstart=function(){event.returnValue =
						// true;};
						// document.oncontextmenu=function(){event.returnValue =
						// true;};
					}

					if (!(_dropdown && System.isTrue(_dropdown.fixed))
							&& !System.compareText(editor.type, "checkbox"))
						editor.select();
				}
				Document.activeEditor = editor;
			}
		}

		function processElementBlur() {
			// document.onselectstart=function(){event.returnValue=(!System.isTrue(Global.disableContextSelect));};
			// document.oncontextmenu=function(){event.returnValue=(!System.isTrue(Global.disableSystemContextMenu));};
			var doblur = (activeElement != Document.activeEditor);
			if (need_processElementBlur == true) {
				if (Document.activeElement) {
					if (typeof(_dropdown_btn) != "undefined" && _dropdown_btn) {
						doblur = doblur
								&& (Document.activeElement != _dropdown_btn)
								&& (activeElement != _dropdown_btn);
					}

					if (typeof(Dropdown.box) != "undefined" && Dropdown.box) {
						var editor = Dropdown.box.editor;
						doblur = doblur
								&& (activeElement != editor)
								&& (!Document.isChild(activeElement,
										Dropdown.box));
					}

					if (doblur) {
						if (Document.activeEditor
								&& Document.activeEditor.dropDownVisible) {
							if (typeof(Dropdown.hideDropDownBox) != "undefined")
								Dropdown.hideDropDownBox();
							// StatusLabel.hide(window);
						}
						set_activeEditor(null);
					}
				} else {
					doblur = false;
				}

				if (activeElement == document.body
						&& Document.skip_activeChanged) {
					Document.skip_activeChanged = false;
					return;
				}
			}
			if ((doblur || !Document.activeEditor)
					&& (activeElement.getAttribute("extra") == "tablecell")) {
				var activeTable = isChildofTable(activeElement);
				if (Document.activeTable != activeTable) {
					if (Document.activeTable) {
						Document.activeTable.focused = false;

						var row = Document.activeTable.activeRow;
						if (row)
							Datatable.refreshTableRowStyle(row);
					}

					Document.activeTable = activeTable;

					if (Document.activeTable) {
						Document.activeTable.focused = true;

						var row = Document.activeTable.activeRow;
						if (row)
							Datatable.refreshTableRowStyle(row);
					}
				}
			}
		}

		Document.forEditor = activeElement;
		if (window.closed)
			return;
		if (activeElement == Document.activeElement)
			return;
		// 如果之前是菜单为激活元素而当前不是的话， 将菜单隐藏
		if (Document.activeElement) {
			if (typeof(Menu) != "undefined"
					&& typeof(Menu.hideMenu) != "undefined") {
				if (Document.activeElement.getAttribute("extra") == "menuframe"
						|| Document.activeElement.getAttribute("extra") == "menuitem") {
					Menu.hideMenu();
				}
			}
		}
		if (activeElement) {

			processElementBlur();

			need_processElementBlur = false;
			switch (activeElement.getAttribute("extra")) {
				case "tablecell" : {
					var row = Table.getRowByCell(activeElement);
					var table = Table.getTableByRow(row);
					var dataset = Control.getElementDataset(activeElement);
					table._activeRow = row;
					table._activeCell = activeElement;
					table._activeCellIndex = activeElement.cellIndex;
					if (row.record) {
						if (dataset.window == window) {
							Dataset.setRecord(dataset, row.record);
						} else {
							dataset.window.Dataset.setRecord(dataset,
									row.record);
						}
					}

					Datatable.setActiveTableCell(row, activeElement.cellIndex);
					table._activeRow = null;
					break;
				}
				case "editor" :
					;
				case "dockeditor" : {
					if (!activeElement.readOnly) {
						set_activeEditor(activeElement);
						need_processElementBlur = true;
					}
					break;
				}
			}
		}
		Document.activeElement = activeElement;

	},

	// 通过sourceIndex属性获取当前元素在all集合中的下标，查找前一个聚焦元素，
	// 条件为TabIndex属性有意义的，不是失效的，不是只读的
	// 对于Td单元格比较特殊， 因为单元格本身是没有TabIndex属性的，也没有生效失效属性的。
	getPriorTabElement : function(obj) {
		var i = obj.sourceIndex - 1;
		var elementCount = document.all.length;
		var tmpObj = null;
		while (i < elementCount) {
			tmpObj = document.all[i];
			if (tmpObj != obj) {
				switch (tmpObj.tagName) {
					case "INPUT" :
					case "TEXTAREA" :
					case "BUTTON" :
						if (tmpObj.tabIndex != -1 && !tmpObj.disabled
								&& !System.isTrue(tmpObj.readOnly)) {
							return tmpObj;
						}
					case "TD" :
						if (tmpObj.extra == "tablecell"
								&& !System.isTrue(tmpObj.readOnly)) {
							return tmpObj;
						}
				}
			}
			i--;
		}
	},

	// 通过sourceIndex属性获取当前元素在all集合中的下标，查找下一个聚焦元素，
	// 条件为TabIndex属性有意义的，不是失效的，不是只读的
	// 对于Td单元格比较特殊， 因为单元格本身是没有TabIndex属性的，也没有生效失效属性的。
	getNextTabElement : function(obj) {
		var i = obj.sourceIndex + 1;
		var elementCount = document.all.length
		var tmpObj = null;
		while (i < elementCount) {
			tmpObj = document.all[i];
			if (tmpObj != obj) {
				switch (tmpObj.tagName) {
					case "INPUT" :
					case "TEXTAREA" :
					case "BUTTON" :
						if (tmpObj.tabIndex != -1 && !tmpObj.disabled
								&& !System.isTrue(tmpObj.readOnly)) {
							return tmpObj;
						}
					case "TD" :
						if (tmpObj.extra == "tablecell"
								&& !System.isTrue(tmpObj.readOnly)) {
							return tmpObj;
						}
				}
			}
			i++;
		}
	},

	control_onkeydown : function() {
		function getCell(element) {
			if (element.getAttribute("extra") == "tablecell")
				return element;
			else if (element.in_table)
				return element.editorHolder;
		}

		function processTab(element) {

			var obj = null;
			if (element.extra == "dockeditor") {
				obj = element.editorHolder;
			} else {
				obj = element;
			}

			if (!obj)
				return;

			if (event.shiftKey)
				obj = Document.getPriorTabElement(obj);
			else
				obj = Document.getNextTabElement(obj);

			try {
				if (obj)
					obj.focus();
			} catch (e) {/* 存在标签页时会报错 */
			}

			event.returnValue = false;

		}
		element = event.srcElement;
		if (Dropdown.isDropdownBoxVisible()) {
			if (Dropdown.window)
				Dropdown.window.Dropdown.processDropDownKeyDown(event.keyCode);
			event.cancelBubble = true;
			event.returnValue = true;
		} else {
			var rowindex, colindex;
			switch (event.keyCode) {
				// Tab
				case 9 : {
					processTab(element);
					break;
				}
					// Enter
				case 13 : {
					if (element.dropDown) {
						Dropdown.hideDropDownBox(element);
					} else if (Global.processEnterAsTab
							&& !System.compareText(element.tagName, "TEXTAREA")
							|| event.shiftKey || event.ctrlKey || event.altKey) {
						var cell = getCell(element);
						if (cell && !event.shiftKey) {
							var row = Table.getRowByCell(cell);
							var table = Table.getTableByRow(row);
							var maxIndex = Datatable.checkTableCellIndex(table,
									9999, 9999);
							if (row.rowIndex == maxIndex[0]
									&& cell.cellIndex == maxIndex[1]
									&& !System.isTrue(table
											.getAttribute("readOnly"))) {
								var dataset = Control
										.getElementDataset(element);
								dataset.insertRecord("end");
								// dataset.modified=false;
								Datatable
										.setActiveTableCell(table.activeRow, 0);
							} else {
								processTab(element);
							}
						} else {
							processTab(element);
						}
					}
					break;
				}
					// Left
				case 37 : {
					var cell = getCell(element);
					if (cell) {
						if ((event.ctrlKey) || (event.altKey)) {
							var table = Table.getTableByCell(cell);
							var rowIndex = Table.getRowByCell(cell).rowIndex;
							var cellIndex = cell.cellIndex;
							cellIndex--;
							Editor
									.setFocusTableCell(table, rowIndex,
											cellIndex);
							event.returnValue = false;
						}
					}
					break;
				}
					// Up
				case 38 : {
					if (!element.readOnly && element.dropDown) {
						Dropdown.showDropDownBox(element);
					} else {
						var cell = getCell(element);
						if (cell) {
							var dataset = Control.getElementDataset(element);
							if (dataset) {
								if (dataset.getCurrent()
										&& dataset.getCurrent().getPrevRecord())
									dataset.movePrev();
								event.returnValue = false;
							}
						}
					}
					break;
				}
					// Right
				case 39 : {
					var cell = getCell(element);
					if (cell) {
						if ((event.ctrlKey) || (event.altKey)) {
							var table = Table.getTableByCell(cell);
							var rowIndex = Table.getRowByCell(cell).rowIndex;
							var cellIndex = cell.cellIndex;
							cellIndex++;
							Editor
									.setFocusTableCell(table, rowIndex,
											cellIndex);
							event.returnValue = false;
						}
					}
					break;
				}
					// Down
				case 40 : {
					// if (event.altKey){
					if (!element.readOnly && element.dropDown) {
						Dropdown.showDropDownBox(element);
					} else {
						var cell = getCell(element);
						if (cell) {
							var table = Table.getTableByCell(cell);
							var dataset = Control.getElementDataset(element);
							if (dataset) {
								if (dataset.getCurrent()
										&& dataset.getCurrent().getNextRecord())
									dataset.moveNext();
								/*
								 * if (dataset.isLast() &&
								 * !System.isTrue(table.getAttribute("readOnly")) &&
								 * !System.isTrue(dataset.readOnly)){
								 * dataset.insertRecord("end");
								 * //dataset.modified=false; }
								 */
								event.returnValue = false;
							}
						}
					}
					break;
				}
					/*
					 * //Insert case 45:{ var cell=getCell(element); if (cell &&
					 * !System.isTrue(Table.getTableByCell(cell).getAttribute("readOnly"))){
					 * var dataset=Control.getElementDataset(element); if
					 * (!System.isTrue(dataset.readOnly)){
					 * dataset.insertRecord("before"); //dataset.modified=false; } }
					 * break; } //Delete case 46:{ if (event.ctrlKey){ var
					 * cell=getCell(element); if (cell){ var
					 * table=Table.getTableByCell(cell); if
					 * (!System.isTrue(table.getAttribute("readOnly"))){ var
					 * dataset=Control.getElementDataset(element); if
					 * (!System.isTrue(dataset.readOnly)){ if
					 * (System.isTrue(table.getAttribute("confirmDelete"))){ if
					 * (confirm(Const.DatasetConfirmDelete)){
					 * dataset.deleteRecord(); } } else{ dataset.deleteRecord(); } }
					 * event.returnValue=false; } } } break; } //Home case 36:{
					 * var cell=getCell(element); if (cell){ if ((event.ctrlKey) ||
					 * (event.altKey)){ var row=Table.getRowByCell(cell);
					 * Datatable.setActiveTableCell(row, 0);
					 * event.returnValue=false; } } break; } //End case 35:{ var
					 * cell=getCell(element); if (cell){ if ((event.ctrlKey) ||
					 * (event.altKey)){ var row=Table.getRowByCell(cell);
					 * Datatable.setActiveTableCell(row, 99999);
					 * event.returnValue=false; } } break; } //Page Up case 33:{
					 * var cell=getCell(element); if (cell &&
					 * !System.isTrue(Table.getTableByCell(cell).getAttribute("readOnly"))){
					 * var dataset=Control.getElementDataset(element); var
					 * pageIndex=(dataset.record)?dataset.record.pageIndex-1:1;
					 * dataset.moveToPage(pageIndex); } break; } //Page Down
					 * case 34:{ var cell=getCell(element); if (cell &&
					 * !System.isTrue(Table.getTableByCell(cell).getAttribute("readOnly"))){
					 * var dataset=Control.getElementDataset(element); var
					 * pageIndex=(dataset.record)?dataset.record.pageIndex+1:1;
					 * dataset.moveToPage(pageIndex); } break; } //F2 case 113:;
					 * //F7 case 118:{ Dropdown.showDropDownBox(element); break; }
					 */
			}
		}
	},

	getAbsPosition : function(obj, offsetObj) {
		var _offsetObj = (offsetObj) ? offsetObj : document.body;
		var x = obj.offsetLeft;
		var y = obj.offsetTop;
		var tmpObj = obj.offsetParent;

		while ((tmpObj != _offsetObj) && tmpObj) {
			x += tmpObj.offsetLeft - tmpObj.scrollLeft + tmpObj.clientLeft;
			y += tmpObj.offsetTop - tmpObj.scrollTop + tmpObj.clientTop;
			tmpObj = tmpObj.offsetParent;
		}
		return ([x, y]);
	},

	isChild : function(obj, parentObj) {
		var tmpObj = obj;
		var result = false;
		if (parentObj) {
			while (tmpObj) {
				if (tmpObj == parentObj) {
					result = true;
					break;
				}
				tmpObj = tmpObj.parentElement;
			}
		}
		return result;
	},

	getAllDataset : function() {

		var datasetArray = Document.array_dataset;
		if (datasetArray == null)
			return;
		var array = [];
		for (var x = 0; x < datasetArray.length; x++) {
			var dataset = datasetArray[x];
			if (dataset.xmlFormat == "records") {
				array[array.length] = dataset;
			}

		}
		return array;

	}
}

// 如果修改了的是activeElement属性，则触发processActiveElementChanged事件
document.onpropertychange = function() {
	// var start = new Date();
	if (event.propertyName == "activeElement") {
		Document.processActiveElementChanged(document.activeElement);
	}
	// jsDebug.debug("..."+((new Date())-start));
}

// 每次都从Menu.array_menu数据中寻找是否有当前元素的右键菜单定义，这样的做法是否效率比较低
/*
 * document.oncontextmenu = function(){
 * event.returnValue=(!System.isTrue(Global.disableSystemContextMenu));
 * if(typeof(ContextMenu)!="undefined") ContextMenu.show(); }
 * 
 * document.onselectstart = function(){
 * event.returnValue=(!System.isTrue(Global.disableContextSelect)); }
 */

document.onkeydown = function() {
	if (Global.onServer && System.isTrue(Global.disableContextRefresh)
			&& event.keyCode == 116) {
		event.keyCode = 0;
		event.cancelBubble = true;
		return false;
	} else if (document.activeElement
			&& document.activeElement.tagName != "BUTTON"
			&& event.keyCode == 13) {
		if (document.body.submit) {
			var button = document.getElementById(document.body.submit);
			if (button) {
				Document.processActiveElementChanged(button);
				try {
					button.focus();
				} catch (e) {
					button.fireEvent("onclick");
				}
			}
		}
	}
}

window.onunload = function() {
	// old_alert("onunload");
	Document.fireUserEvent("page_onUnload", []);

	// XmlHttpPool.clear(); modify by easonwu

	Control.uninitElements();

	for (var i = 0; i < Document.array_dataset.length; i++) {
		var dataset = Document.array_dataset[i];
		if (dataset.window == window) {
			dataset.disableControls();
			dataset.disableEvents();
			dataset.setMasterDataset(null);
			dataset.window = null;
			if (typeof(dataset.datapilot) != "undefined")
				dataset.datapilot = null;
			if (typeof(dataset.pilot) != "undefined")
				dataset.pilot = null;
			Dataset.freeDataset(dataset);
			dataset = null;
		}
	}
	Document.array_dataset = null;

	if (array_tabsets) {
		for (var i = 0; i < array_tabsets.length; i++) {
			Tabset.destroy(array_tabsets[i]);
		}
		array_tabsets = null;
	}

	if (array_forms) {
		for (var i = 0; i < array_forms.length; i++) {
			Form.destroy(array_forms[i]);
		}
		array_forms = null;
	}

	if (typeof(_table_textarea) == "object") {
		Control.uninitElement(_table_textarea);
	}
	if (typeof(_table_checkbox) == "object") {
		Control.uninitElement(_table_checkbox);
	}
	if (typeof(_table_texteditor) == "object") {
		Control.uninitElement(_table_texteditor);
	}
	if (typeof(_table_passwordeditor) == "object") {
		Control.uninitElement(_table_passwordeditor);
	}
	if (typeof(_table_ipeditor) == "object") {
		Control.uninitElement(_table_ipeditor);
	}
	if (typeof(_table_dateeditor) == "object") {
		Control.uninitElement(_table_dateeditor);
	}
	if (typeof(_table_timeeditor) == "object") {
		Control.uninitElement(_table_timeeditor);
	}
	if (typeof(_table_datetimeeditor) == "object") {
		Control.uninitElement(_table_datetimeeditor);
	}
	if (typeof(_popup_texteditor) == "object") {
		Control.uninitElement(_popup_texteditor);
	}

	for (var i = 0; i < _array_dropdown.length; i++) {
		var dropdown = _array_dropdown[i];
		if (dropdown) {
			if (typeof(dropdown.table) != "undefined")
				dropdown.table = null;
			if (typeof(dropdown.window) != "undefined")
				dropdown.window = null;
			if (typeof(dropdown.dropdownbox) != "undefined")
				dropdown.dropdownbox = null;
			dropdown = null;
		}
	}
	_array_dropdown = null;

	Dropdown.window = null;
	if (Dropdown.box) {
		Dropdown.box.dropDown = null;
	}
	Dropdown.box = null;
	Dropdown.table = null;
	Dropdown.frame = null;
	Dropdown.dataset = null;
	Dropdown.date_box = null;
	if (Dropdown.parentbox) {
		Dropdown.parentbox.editor = null;
		Dropdown.parentbox.dropDown = null;
	}
	Dropdown.parentwindow = null;
	Dropdown.parentbox = null;

	var pilots = Document.array_pilot;
	if (pilots) {
		var pilots_length = pilots.length;
		for (var i = 0; i < pilots_length; i++) {
			var pilot = pilots[i];
			if (pilot.className == "customerpilot") {
				destroyCustomerPilot(pilot);
			}
		}
	}
}
/*
 * window.onresize = function(){ if (typeof(Editor.sizeDockEditor)!="undefined")
 * Control.adjustControlsSize(); }
 */

 var old_alert = window.alert;
 window.alert = function(message) {
 if (window.dialogArguments && document.readyState != "complete") {
 old_alert();
 } else {
 MessageBox.Show(null, message, null, 'OK', 'Warning');
 }
 }
window.alert2 = function(message) {
	MessageBox.Show(message);
}

window.confirm = function(message) {
	return (MessageBox.Show(null, message, null, 'OKCancel', 'Asterisk') == "OK"
			? true
			: false);
}

window.confirm2 = function(message) {
	return (MessageBox.Show(null, message, null, 'YesNo', 'Asterisk') == "Yes"
			? true
			: false);
}
window.confirm3 = function(message) {
	return (MessageBox.Show(null, message, null, 'YesNoCancel', 'Asterisk') == "Yes"
			? true
			: false);
}
window.info = function(message) {
	return MessageBox.Show(null, message, null, 'OK', 'Information');
}
window.warn = function(message) {
	return MessageBox.Show(null, message, null, 'OK', 'Warning');
}
window.warn2 = function(message) {
	return MessageBox.Show(null, message, null, 'AbortRetryIgnore', 'Warning');
}
window.error = function(message) {
	return MessageBox.Show(null, message, null, 'OK', 'Error');
}
window.error2 = function(message) {
	return MessageBox.Show(null, message, null, 'RetryCancel', 'Error');
}
window.log = function() {
	return doError();
}
window.log2 = function(message) {
	return MessageBox.Show(null, message, null, 'LogOK', null, 1);
}

var w;
function doError() {
	if (!w || w.closed) {
		var x = screen.width;
		var y = screen.Height;
		var top = (y - 124) / 2;
		var left = (x - 400) / 2;
		w = window.open(path_prefix + "public/components/messageBox/error.htm",
				"_webxf_error_win", "width=385,height=80,top=" + top + ",left="
						+ left + "");
		w.focus();
	}
	return true;
}

var __S = [200, 300];
var __M = [300, 400];
var __L = [400, 500];
var __XL = [500, 600];
var __XXL = [600, 700];

function openDialog(url, arg, sizeConfig, dialogWidth, dialogHeight) {
	var sizeConfigResult = "";
	if (!sizeConfig || sizeConfig == "") {
		sizeConfigResult = "dialogWidth:" + dialogWidth + "px;dialogHeight:"
				+ dialogHeight + "px;";
	} else {
		var __config = eval("__" + sizeConfig);
		sizeConfigResult = "dialogWidth:" + __config[0] + "px;dialogHeight:"
				+ __config[1] + "px;";
	}
	return window.showModalDialog(url, arg, "status:no;help:no;scroll:no;"
					+ sizeConfigResult);
}
// 显示悬浮弹出窗口
function openModelessDialog(url, arg, sizeConfig, dialogWidth, dialogHeight) {
	var sizeConfigResult = "";
	if (!sizeConfig || sizeConfig == "") {
		sizeConfigResult = "dialogWidth:" + dialogWidth + "px;dialogHeight:"
				+ dialogHeight + "px;";
	} else {
		var __config = eval("__" + sizeConfig);
		sizeConfigResult = "dialogWidth:" + __config[0] + "px;dialogHeight:"
				+ __config[1] + "px;";
	}
	return window.showModelessDialog(url, arg, "status:no;help:no;scroll:no;"
					+ sizeConfigResult);
}

// date format

var MONTH_NAMES = ['January ', 'February ', 'March ', 'April ', 'May ',
		'June ', 'July ', 'August ', 'September ', 'October ', 'November ',
		'December ', 'Jan ', 'Feb ', 'Mar ', 'Apr ', 'May ', 'Jun ', 'Jul ',
		'Aug ', 'Sep ', 'Oct ', 'Nov ', 'Dec'];
var DAY_NAMES = ['Sunday ', 'Monday ', 'Tuesday ', 'Wednesday ', 'Thursday ',
		'Friday ', 'Saturday ', 'Sun ', 'Mon ', 'Tue ', 'Wed ', 'Thu ', 'Fri ',
		'Sat'];

function LZ(x) {
	return (x < 0 || x > 9 ? "" : "0") + x
}

function isDate(val, format) {
	var date = getDateFromFormat(val, format);
	if (date == 0) {
		return false;
	}
	return true;
}

function compareDates(date1, dateformat1, date2, dateformat2) {
	var d1 = getDateFromFormat(date1, dateformat1);
	var d2 = getDateFromFormat(date2, dateformat2);
	if (d1 == 0 || d2 == 0) {
		return -1;
	} else if (d1 > d2) {
		return 1;
	}
	return 0;
}

function formatDate(date, format) {
	format = format + "";
	var result = "";
	var i_format = 0;
	var c = "";
	var token = "";
	var y = date.getYear() + "";
	var M = date.getMonth() + 1;
	var d = date.getDate();
	var E = date.getDay();
	var H = date.getHours();
	var m = date.getMinutes();
	var s = date.getSeconds();
	var yyyy, yy, MMM, MM, dd, hh, h, mm, ss, ampm, HH, H, KK, K, kk, k;
	var value = {};

	if (y.length < 4) {
		y = "" + (y - 0 + 1900);
	}
	value["y"] = "" + y;
	value["yyyy"] = y;
	value["yy"] = y.substring(2, 4);
	value["M"] = M;
	value["MM"] = LZ(M);
	value["MMM"] = MONTH_NAMES[M - 1];
	value["NNN"] = MONTH_NAMES[M + 11];
	value["d"] = d;
	value["dd"] = LZ(d);
	value["E"] = DAY_NAMES[E + 7];
	value["EE"] = DAY_NAMES[E];
	value["H"] = H;
	value["HH"] = LZ(H);

	if (H == 0) {
		value["h"] = 12;
	} else if (H > 12) {
		value["h"] = H - 12;
	} else {
		value["h"] = H;
	}

	value["hh"] = LZ(value["h"]);
	if (H > 11) {
		value["K"] = H - 12;
	} else {
		value["K"] = H;
	}

	value["k"] = H + 1;
	value["KK"] = LZ(value["K"]);
	value["kk"] = LZ(value["k"]);
	if (H > 11) {
		value["a"] = "PM";
	} else {
		value["a"] = "AM";
	}

	value["m"] = m;
	value["mm"] = LZ(m);
	value["s"] = s;
	value["ss"] = LZ(s);

	while (i_format < format.length) {
		c = format.charAt(i_format);
		token = "";
		while ((format.charAt(i_format) == c) && (i_format < format.length)) {
			token += format.charAt(i_format++);
		}
		if (value[token] != null) {
			result = result + value[token];
		} else {
			result = result + token;
		}
	}
	return result;
}

function _isInteger(val) {
	var digits = "1234567890";
	for (var i = 0; i < val.length; i++) {
		if (digits.indexOf(val.charAt(i)) == -1) {
			return false;
		}
	}
	return true;
}

function _getInt(str, i, minlength, maxlength) {
	for (var x = maxlength; x >= minlength; x--) {
		var token = str.substring(i, i + x);
		if (token.length < minlength) {
			return null;
		}
		if (_isInteger(token)) {
			return token;
		}
	}
	return null;
}

function getDateFromFormat(val, format) {
	val = val + "";
	format = format + "";
	var i_val = 0;
	var i_format = 0;
	var c = "";
	var token = "";
	var token2 = "";
	var x, y;
	var now = new Date();
	var year = now.getYear();
	var month = now.getMonth() + 1;
	var date = 1;
	var hh = now.getHours();
	var mm = now.getMinutes();
	var ss = now.getSeconds();
	var ampm = "";

	while (i_format < format.length) {
		c = format.charAt(i_format);
		token = "";
		while ((format.charAt(i_format) == c) && (i_format < format.length)) {
			token += format.charAt(i_format++);
		}
		if (token == "yyyy" || token == "yy" || token == "y") {
			if (token == "yyyy") {
				x = 4;
				y = 4;
			}
			if (token == "yy") {
				x = 2;
				y = 2;
			}
			if (token == "y") {
				x = 2;
				y = 4;
			}
			year = _getInt(val, i_val, x, y);
			if (year == null) {
				return 0;
			}
			i_val += year.length;
			if (year.length == 2) {
				if (year > 70) {
					year = 1900 + (year - 0);
				} else {
					year = 2000 + (year - 0);
				}
			}
		} else if (token == "MMM" || token == "NNN") {
			month = 0;
			for (var i = 0; i < MONTH_NAMES.length; i++) {
				var month_name = MONTH_NAMES[i];
				if (val.substring(i_val, i_val + month_name.length) == month_name) {
					if (token == "MMM" || (token == "NNN" && i > 11)) {
						month = i + 1;
						if (month > 12) {
							month -= 12;
						}
						i_val += month_name.length;
						break;
					}
				}
			}
			if ((month < 1) || (month > 12)) {
				return 0;
			}
		} else if (token == "EE" || token == "E") {
			for (var i = 0; i < DAY_NAMES.length; i++) {
				var day_name = DAY_NAMES[i];
				if (val.substring(i_val, i_val + day_name.length) == day_name) {
					i_val += day_name.length;
					break;
				}
			}
		} else if (token == "MM" || token == "M") {
			month = _getInt(val, i_val, token.length, 2);
			if (month == null || (month < 1) || (month > 12)) {
				return 0;
			}
			i_val += month.length;
		} else if (token == "dd" || token == "d") {
			date = _getInt(val, i_val, token.length, 2);
			if (date == null || (date < 1) || (date > 31)) {
				return 0;
			}
			i_val += date.length;
		} else if (token == "hh" || token == "h") {
			hh = _getInt(val, i_val, token.length, 2);
			if (hh == null || (hh < 1) || (hh > 12)) {
				return 0;
			}
			i_val += hh.length;
		} else if (token == "HH" || token == "H") {
			hh = _getInt(val, i_val, token.length, 2);
			if (hh == null || (hh < 0) || (hh > 23)) {
				return 0;
			}
			i_val += hh.length;
		} else if (token == "KK" || token == "K") {
			hh = _getInt(val, i_val, token.length, 2);
			if (hh == null || (hh < 0) || (hh > 11)) {
				return 0;
			}
			i_val += hh.length;
		} else if (token == "kk" || token == "k") {
			hh = _getInt(val, i_val, token.length, 2);
			if (hh == null || (hh < 1) || (hh > 24)) {
				return 0;
			}
			i_val += hh.length;
			hh--;
		} else if (token == "mm" || token == "m") {
			mm = _getInt(val, i_val, token.length, 2);
			if (mm == null || (mm < 0) || (mm > 59)) {
				return 0;
			}
			i_val += mm.length;
		} else if (token == "ss" || token == "s") {
			ss = _getInt(val, i_val, token.length, 2);
			if (ss == null || (ss < 0) || (ss > 59)) {
				return 0;
			}
			i_val += ss.length;
		} else if (token == "a") {
			if (val.substring(i_val, i_val + 2) == "am") {
				ampm = "AM";
			} else if (val.substring(i_val, i_val + 2) == "pm") {
				ampm = "PM";
			} else {
				return 0;
			}
			i_val += 2;
		} else {
			if (val.substring(i_val, i_val + token.length) != token) {
				return 0;
			} else {
				i_val += token.length;
			}
		}
	}
	if (i_val != val.length) {
		return 0;
	}
	if (month == 2) {
		if (((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0)) {
			if (date > 29) {
				return 0;
			}
		} else {
			if (date > 28) {
				return 0;
			}
		}
	}
	if ((month == 4) || (month == 6) || (month == 9) || (month == 11)) {
		if (date > 30) {
			return 0;
		}
	}
	if (hh < 12 && ampm == "PM") {
		hh = hh - 0 + 12;
	} else if (hh > 11 && ampm == "AM") {
		hh -= 12;
	}
	var newdate = new Date(year, month - 1, date, hh, mm, ss);
	return newdate.getTime();
}

function parseDate(val) {
	var preferEuro = (arguments.length == 2) ? arguments[1] : false;
	generalFormats = ['y -M - d ', 'MMM d, y ', 'MMM d, y ', 'y - MMM - d ',
			'd - MMM - y ', 'MMM d'];
	monthFirst = ['M / d / y ', 'M - d - y ', 'M.d.y ', 'MMM - d ', 'M / d ',
			'M - d'];
	dateFirst = ['d / M / y ', 'd - M - y ', 'd.M.y ', 'd - MMM ', 'd / M ',
			'd - M'];
	var checkList = ['generalFormats',
			preferEuro ? 'dateFirst ' : 'monthFirst',
			preferEuro ? 'monthFirst ' : 'dateFirst'];
	var d = null;
	for (var i = 0; i < checkList.length; i++) {
		var l = window[checkList[i]];
		for (var j = 0; j < l.length; j++) {
			d = getDateFromFormat(val, l[j]);
			if (d != 0) {
				return new Date(d);
			}
		}
	}
	return null;
}

System = {
	processException : function(e) {
		switch (typeof(e)) {
			case "string" : {
				if (e != "abort") {
					if (e)
						alert(e);
					else
						alert(Const.ErrUnknown);
				}
				break;
			}

			case "object" : {
				alert(e.description + "\n" + Const.ErrType + ":"
						+ (e.number & 0xFFFF));
				break;
			}
		}
	},
	trimStr : function(str) {
		str = System.getValidStr(str);
		if (!str)
			return "";
		/*
		 * for(var i=str.length-1; i>=0; i--){ if (str.charCodeAt(i, 10)!=32)
		 * break; } return str.substr(0, i+1);
		 */
		return str.replace(/(^\s*)|(\s*$)/g, "");
	},
	getValidStr : function(str) {
		return str;
	},
	encode : function(strIn) {
		var intLen = strIn.length;
		var strOut = "";
		var strTemp;

		for (var i = 0; i < intLen; i++) {
			strTemp = strIn.charCodeAt(i);
			if (strTemp > 255) {
				tmp = strTemp.toString(16);
				for (var j = tmp.length; j < 4; j++)
					tmp = "0" + tmp;
				strOut = strOut + "^" + tmp;
			} else {
				if (strTemp < 48 || (strTemp > 57 && strTemp < 65)
						|| (strTemp > 90 && strTemp < 97) || strTemp > 122) {
					tmp = strTemp.toString(16);
					for (var j = tmp.length; j < 2; j++)
						tmp = "0" + tmp;
					strOut = strOut + "~" + tmp;
				} else {
					strOut = strOut + strIn.charAt(i);
				}
			}
		}
		return (strOut);
	},
	decode : function(strIn) {
		var intLen = strIn.length;
		var strOut = "";
		var strTemp;

		for (var i = 0; i < intLen; i++) {
			strTemp = strIn.charAt(i);
			switch (strTemp) {
				case "~" : {
					strTemp = strIn.substring(i + 1, i + 3);
					strTemp = parseInt(strTemp, 16);
					strTemp = String.fromCharCode(strTemp);
					strOut = strOut + strTemp;
					i += 2;
					break;
				}
				case "^" : {
					strTemp = strIn.substring(i + 1, i + 5);
					strTemp = parseInt(strTemp, 16);
					strTemp = String.fromCharCode(strTemp);
					strOut = strOut + strTemp;
					i += 4;
					break;
				}
				default : {
					strOut = strOut + strTemp;
					break;
				}
			}

		}
		return (strOut);
	},
	getEncodeStr : function(str) {
		return System.encode(System.getValidStr(str));
	},

	getDecodeStr : function(str) {
		return System.decode(System.getValidStr(str));
	},

	compareText : function(str1, str2) {
		return (str1 == str2);
	},

	isTrue : function(value) {
		return (value == true || value == "true" || (typeof(value) == "number" && value != 0));
	},

	getInt : function(value) {
		var result = parseInt(value);
		if (isNaN(result))
			result = 0;
		return result;
	}
}

/**
 * 编辑输入框组件
 * 
 */
var Editor = {

	needUpdateEditor : true,

	getKeyValue : function() {
		return this.keyValue;
	},
	getDataType : function() {
		return this.dataType;
	},
	isReadOnly : function() {
		return System.isTrue(this._readOnly);
	},
	getDropDown : function() {
		return this.dropDown;
	},

	checkbox_onclick : function() {
		Editor.processEditorValueChanged(event.srcElement);
	},

	onpropertychange : function() {
		if (event.propertyName == "value") {
			var editor = event.srcElement;
			if (Document.activeEditor) {
				if (Document.activeEditor == editor)
					Editor.processEditorValueChanged(editor);
			}
		}
	},
	onkeypress : function() {
		if (event.srcElement.readOnly || !event.srcElement.contentEditable) {
			event.returnValue = false;
			return;
		}

		var result = true;
		if (event.srcElement.getAttribute("dataType") == "int") {
			result = (event.keyCode == 45 || (event.keyCode >= 48 && event.keyCode <= 57));
		}
		event.returnValue = result;
	},

	setReadOnly : function(_readOnly) {
		var editor = this;
		if (editor) {
			with (editor) {
				if (_readOnly) {
					editor.readOnly = true;
					style.color = "dimgray";

					if (editor.dropDown) {
						style.background = "";
						style.cursor = "default";
					}
					style.backgroundColor = "#E5F3F8";// "whitesmoke";
				} else {
					editor.readOnly = false;
					style.color = "black";

					if (editor.dropDown) {
						style.background = "url("
								+ path_prefix
								+ "public/skins/bsn/downdot.gif) top right no-repeat white";
						style.cursor = "hand";
					}
					style.backgroundColor = "";
				}
			}

		}
	},

	isDataEditorEditable : function(editor, dataset) {

		var editable = !System.isTrue(editor._readOnly);
		if (dataset) {
			var field = Control.getElementField(editor);

			editable = editable && Dataset.isFieldEditable(dataset, field);
		}
		return editable;
	},

	processDropDownSelected : function(editor, record) {
		var _dropdown = Editor.getEditorDropDown(editor);
		if (!_dropdown)
			return;

		var eventName = Document.getElementEventName(_dropdown, "onSelect");
		needAbort = (Document.isUserEventDefined(eventName) && !Document
				.fireUserEvent(eventName, [_dropdown, record, editor]));
		if (needAbort)
			return;

		switch (_dropdown.type) {
			case "date" : {
				if (record) {
					var value = record.getValue("value");
					if (value == "") {
						// nothing-todo;
					} else {
						switch (editor.dataType) {
							case "date" :
								value = formatDate(value, "yyyy-MM-dd");
								break;
							case "time" :
								value = formatDate(value, "HH:mm:ss");
								break;
							case "datetime" :
								value = formatDate(value, "yyyy-MM-dd HH:mm:ss");
								break;
							case "yearmonth" :
								value = formatDate(value, "yyyy-MM");
								break;
							default :
								value = formatDate(value, "yyyy-MM-dd");
								break;
						}
					}
					Control.setElementValue(editor, value);
				}
				break;
			}
			default : {
				var fieldmaps = [];

				if (_dropdown.writeFields) {
					var readFields = _dropdown.readFields.split(",");
					var writeFields = _dropdown.writeFields.split(",");
					for (var i = 0; i < writeFields.length; i++) {
						fieldmaps[i] = {};
						fieldmaps[i].writeField = writeFields[i];
						if (readFields[i]) {
							fieldmaps[i].readField = readFields[i];
						} else {
							fieldmaps[i].readField = writeFields[i];
						}
					}
				}

				var dataField = editor.getAttribute("field");
				var dataset = Control.getElementDataset(editor);
				if (dataset) {
					if (fieldmaps.length > 0) {
						for (var i = 0; i < fieldmaps.length; i++) {
							if (record) {
								dataset
										.setValue(
												fieldmaps[i].writeField,
												record
														.getValue(fieldmaps[i].readField));
							} else {
								dataset.setValue(fieldmaps[i].writeField, "");
							}
						}
					} else {
						if (record) {
							if (_dropdown.type == "list") {
								Control.setElementValue(editor, record
												.getValue("value"));
							} else if (dataField) {
								dataset.setValue(dataField, record
												.getValue(dataField));
							}
						} else {
							if (_dropdown.type == "list") {
								Control.setElementValue(editor, "");
							} else if (dataField) {
								dataset.setValue(dataField, "");
							}
						}
					}
				} else {
					if (record) {
						if (fieldmaps.length > 0) {
							editor.value = record
									.getValue(fieldmaps[0].readField);
						} else {
							if (_dropdown.type == "list") {
								Control.setElementValue(editor, record
												.getValue("value"));
							} else {
								if (dataField) {
									editor.value = record.getValue(dataField);
								} else {
									editor.value = record.getValue(0);
								}
							}
						}
					} else {
						if (fieldmaps.length > 0) {
							editor.value = "";
						} else {
							if (_dropdown.type == "list") {
								Control.setElementValue(editor, "");
							} else {
								editor.value = "";
							}
						}
					}
				}
			}
		}
		editor.dropDownSelectedValue = editor.value;

		// 如果有subList属性，则更新subEditor的parentValueId。
		if ((editor.subList != undefined) && editor.subList != "") {
			Editor.refreshSubEditor(editor);
		}
	},
	// 检查校验editor的内容是否符合格式要求。
	validEditorInput : function(editor) {

		var _dropdown = Editor.getEditorDropDown(editor);
		if (!editor.value || (_dropdown && _dropdown.type == "list"))
			return;

		if (editor.getAttribute("dataType") == "int") {
			if (isNaN(parseInt(editor.value)))
				throw Const.ErrTypeInt.replace("%s", editor.value);
		} else if (editor.getAttribute("dataType") == "double") {
			var doublePatten = /^[-\+]?\d+(\.\d+)?$/;
			if (!doublePatten.test(editor.value))
				throw Const.ErrTypeDouble.replace("%s", editor.value);
		} else if (editor.getAttribute("dataType") == "money") {
			var moneyPatten = /^\d+(\.\d{1,2})?$/;
			if (!moneyPatten.test(editor.value))
				throw Const.ErrTypeMoney.replace("%s", editor.value);
		}
	},
	// 更新editor的内容。
	updateEditorInput : function(editor) {
		try {
			if (window.closed)
				return;

			editor.modified = (Control.getElementValue(editor) != editor.oldValue);

			if (editor.modified) {

				Editor.validEditorInput(editor);

				var dataset = Control.getElementDataset(editor);
				var editorValue = Control.getElementValue(editor);
				var dataField = editor.getAttribute("field");

				var eventName = Document
						.getElementEventName(editor, "onUpdate");
				needAbort = (Document.isUserEventDefined(eventName) && !Document
						.fireUserEvent(eventName, [editor]));
				if (needAbort)
					return;

				var _dropdown = Editor.getEditorDropDown(editor);
				if (_dropdown && editor.dropDownSelectedValue != editor.value
						&& !System.isTrue(_dropdown.fixed)) {

					if (editor.value != "") {
						var notInList = false;
						switch (_dropdown.type) {
							case "list" : {

								var items = Dropdown
										.getDropDownItems(_dropdown);
								if (items) {
									notInList = (items.find(["value"],
											[editorValue]) == null);
								}
								break;
							}
							case "dataset" : {
								var tmp_dataset = _dropdown.dataset;
								if (tmp_dataset) {
									if (typeof(tmp_dataset) == "string")
										tmp_dataset = Dataset
												.getDatasetByID(tmp_dataset);
									if (tmp_dataset) {
										var dataField = _dropdown.dataField;
										if (!dataField)
											dataField = editor
													.getAttribute("field");
										if (dataField) {
											var record = tmp_dataset
													.find([dataField],
															[editor.value]);
											notInList = (record == null);
											if (!notInList)
												Editor.processDropDownSelected(
														editor, record);
										}
									}
								}
								break;
							}
						}

						if (notInList && System.isTrue(_dropdown.checkInput)) {
							throw Const.ErrOutOfDropDownList;
						}
					} else {
						switch (_dropdown.type) {
							case "dynamic" :
								;
							case "custom" : {
								Editor.processDropDownSelected(editor, null);
								break;
							}
						}
					}
				}

				editor.dropDownSelectedValue = editor.value;

				if (dataset && dataset.record) {
					// if (dataset.window==window){
					dataset.record.setValue(dataField, System
									.trimStr(editorValue));
					// }
					// else{
					// dataset.window.Record._setValue(dataset.record,
					// dataField, System.trimStr(editorValue));
					// }
				}
			}

		} catch (e) {
			System.processException(e);
			Control.refreshElementValue(editor);
			editor.focus();
			// throw "abort";
		}
	},
	// editor值改变的事件真正响应处理方法。
	processEditorValueChanged : function(editor) {

		var dataset = Control.getElementDataset(editor);
		if (dataset) {
			var value = editor.value;

			if (!dataset.record && editor.value != "") {
				dataset.insertRecord("end");
				if (dataset.state == "insert") {
					editor.value = value;
					editor.oldValue = "";
				}
			}
		}

		editor.modified = (Control.getElementValue(editor) != editor.oldValue);

		if (editor.dropDownVisible && Dropdown.window)
			Dropdown.window.Dropdown.locate();

	},

	// 更新subEditor同时下载数据，选择了关联框时执行。
	refreshSubEditor : function(editor) {
		// alert("refreshSubEditor "+editor.id);

		var subEditor = document.getElementById(editor.subList);
		if (subEditor == null || subEditor == undefined)
			return;

		var subDropdown = Editor.getEditorDropDown(subEditor);
		if (!subDropdown)
			return;

		if (subDropdown._items) {
			subDropdown._items.clearData();
		}
		subEditor.value = "";

		var parentValueId = Editor.getEditorDropDown(editor)._items
				.getValue("valueId");
		if (subDropdown.getAttribute("configParams") != null) {
			var subConfigParams = subDropdown.getAttribute("configParams")
					+ parentValueId;
			subDropdown.setAttribute("configParams", subConfigParams);
		} else {
			subDropdown.setAttribute("parentValueId", parentValueId);
		}

		if (parentValueId != null) {
			Dropdown.hideDropDownBox();
			// editor.blur();

			if (parentValueId != "") {
				subDropdown.dataloaded = "false";
				// 这里再设置"false"。不支持静态数据的多级关联。
				subDropdown.staticDataSource = "false";
				Dropdown.getDropDownItems(subDropdown);
			}
			// defaultValue
			if (subDropdown.defaultValue && subDropdown.defaultValue != null) {
				var subDataset = subDropdown._items;
				subDataset.disableControls();
				subDataset.setRecord(subDataset.locate("value",
						subDropdown.defaultValue));
				subDataset.enableControls();
			}

			subEditor.value = subDropdown._items.getValue("label");
			var dataset = Control.getElementDataset(subEditor);
			if (dataset) {
				// old_alert("subDropdown:"+subDropdown._items.getValue("value"));
				// old_alert("subEditor.field:"+subEditor.field);
				dataset._setValue(subEditor.field, subDropdown._items
								.getValue("value"));
			}
		}

		// 递归遍历
		if ((subEditor.subList != undefined) && subEditor.subList != "") {
			Editor.refreshSubEditor(subEditor);
		}

		return;
	},

	// 更新subEditor只做设置，不下载数据。初始化关联框时执行。
	setSubEditor : function(editor, parentValueId) {

		// alert("setSubEditor "+editor.id);
		var subEditor = document.getElementById(editor.subList);
		if (subEditor == null || subEditor == undefined)
			return;

		var subDropdown = Editor.getEditorDropDown(subEditor);
		if (!subDropdown)
			return;

		if (subDropdown._items) {
			subDropdown._items.clearData();
		}

		subDropdown.dataloaded = "false";
		// 这里再设置"false"，不支持静态数据的多级关联。
		subDropdown.staticDataSource = "false";

		if (null == parentValueId || parentValueId == "") {
			subDropdown.setAttribute("parentValueId", null);
			return;
		}
		var subConfigParams = subDropdown.getAttribute("configParams");
		if (subConfigParams != null) {
			subConfigParams = subDropdown.getAttribute("configParams")
					+ parentValueId;
			subDropdown.setAttribute("configParams", subConfigParams);
		} else {
			subEditor.setAttribute("parentValueId", parentValueId);
			subDropdown.setAttribute("parentValueId", parentValueId);
		}

		return;
	},

	// 获取跟指定editor邦定的DropDown组件。
	getEditorDropDown : function(editor) {
		var _dropdown = editor.getAttribute("dropDown");

		/*
		 * if(editor.tagName=="TD" && editor.dataset.getCurrent() &&
		 * editor.dataset.id=="assureInfo" &&
		 * editor.dataset.getValue("field11")=="0001"){ alert(11); _dropdown =
		 * "assureContentInfo"; }else{ alert(editor.tagName);
		 * alert(editor.dataset.getCurrent()); alert(editor.dataset.id);
		 * alert(editor.dataset.getValue("field11")); alert(10); }
		 */

		if (!_dropdown) {
			var field = Control.getElementField(editor);
			if (field)
				_dropdown = field.dropDown;
		}
		if (_dropdown)
			eval("var _dropdown=" + _dropdown);
		return _dropdown;
	},

	sizeDockEditor : function(editor) {
		var _editor = (editor) ? editor : ((Document.activeEditor)
				? (Document.activeEditor)
				: false);
		if (!_editor)
			return;

		var holder = _editor.editorHolder;
		if (!holder)
			return;

		var pos = Document.getAbsPosition(holder);
		with (_editor) {
			if (System.compareText(_editor.tagName, "TEXTAREA")) {
				style.posLeft = pos[0] - 1;
				style.posTop = pos[1] - 1;
				style.width = (holder.offsetWidth < 150)
						? 150
						: holder.offsetWidth + 1;
				style.height = (holder.offsetHeight < 150)
						? 150
						: holder.offsetHeight + 1;
			} else if (!System.compareText(type, "checkbox")) {
				style.posLeft = pos[0] - 1;
				style.posTop = pos[1] - 1;
				style.width = holder.offsetWidth + 1;
				style.height = holder.offsetHeight + 1;
			} else {
				style.posLeft = pos[0];
				style.posTop = pos[1];
				style.width = holder.clientWidth;
				style.height = holder.clientHeight;

				if (offsetWidth > 18) {
					style.borderLeftWidth = (offsetWidth - 18) / 2;
					style.borderRightWidth = (offsetWidth - 18) / 2;
				}
			}
		}
	},

	showDockEditor : function(holder, noCheck) {
		if (!noCheck) {
			if (System.isTrue(holder.getAttribute("readOnly")))
				return;// throw "abort";
			var _dataset = Control.getElementDataset(holder);
			if (!Editor.isDataEditorEditable(holder, _dataset))
				return;// throw "abort";
		}
		editor = Editor.getDockEditor(holder);
		if (editor.editorHolder == holder)
			return

		with (editor) {
			if (style.visiblity != "visible") {
				editor.editorHolder = holder;
				editor.dataType = holder.getAttribute("dataType");
				editor.editorType = holder.getAttribute("editorType");
				editor.field = holder.getAttribute("field");
				editor.dropDown = holder.getAttribute("dropDown");
				if (holder.getAttribute("maxLength") != null
						&& holder.getAttribute("maxLength") != "")
					editor.maxLength = holder.getAttribute("maxLength");

				if (System.compareText(holder.tagName, "TD")) {
					var table = Table.getTableByCell(holder);
					if (table)
						table.editor = editor;
					editor.in_table = true;
				} else {
					editor.in_table = false;
				}

				Dataset.setElementDataset(editor, _dataset);

				Editor.sizeDockEditor(editor);
				// style.visibility="visible";
				style.display = "";
			}

			editor.focus();
		}
		if (holder.extra == "tablecell") {
			Dropdown.btn_onmousedown2(editor);
		}

	},

	hideDockEditor : function(editor) {
		// if (editor.style.visibility=="visible"){
		if (editor.style.display == "") {
			Document.skip_activeChanged = true;
			// editor.style.visibility="hidden";
			editor.style.display = "none";
			Dataset.setElementDataset(editor, null);

			var holder = editor.editorHolder;
			if (holder) {
				if (System.compareText(holder.tagName, "TD")) {
					var table = Table.getTableByCell(holder);
					if (table)
						table.editor = null;
				}
				editor.editorHolder = null;
			}
		}
	},

	getDockEditor : function(holder) {
		var result = null;
		var editorType = holder.getAttribute("editorType");

		switch (editorType) {
			case "textarea" : {
				if (typeof(_table_textarea) == "undefined") {
					result = document
							.createElement("<TEXTAREA id=_table_textarea class=dockeditor extra=dockeditor tabindex=-1"
									+
									// " style=\"position: absolute; visibility:
									// hidden\"></TEXTAREA>");
									" style=\"position: absolute; display: none\"></TEXTAREA>");
					document.body.appendChild(result);
					initEditor(result);
				} else {
					result = _table_textarea;
				}
				break;
			}
			case "checkbox" : {
				if (typeof(_table_checkbox) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_checkbox type=checkbox hidefocus=false class=dockeditor extra=dockeditor tabindex=-1"
									+
									// " style=\"position: absolute; visibility:
									// hidden; background-color: window;\">");
									" style=\"position: absolute; display: none; background-color: window;\">");
					document.body.appendChild(result);
					initEditor(result);
				} else {
					result = _table_checkbox;
				}
				break;
			}
			case "password" : {
				if (typeof(_table_passwordeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_passwordeditor type=password class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					result.onfocus = function() {
						var result = openDialog(SystemContext.appContextPath+"/cs/boa/password.jsp",
								null, "", "300px", "200px");
						if (typeof(result) != "undefined" && result != null
								&& result != "") {
							this.value = result;
						}
						this.blur();
					}
				} else {
					result = _table_passwordeditor;
				}
				break;
			}
			case "pop" : {
				if (typeof(_table_dockinputeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_dockinputeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					result.onfocus = function() {

						var dataset = Control.getElementDataset(this);

						var key = dataset.getValue("attrID");

						if (!key) {
							key = dataset.getValue("attrId");
						}

						var result = openDialog(SystemContext.appContextPath+"/cs/boa/inputText.jsp",
								[key, dataset], "", "600px", "400px");
						/*
						 * if(typeof(result)!="undefined"&&result!=null&&result!=""){
						 * this.value=result; }
						 */
						this.blur();
					}
				}// add by wmc -- ?§??×??¨???????ò
				else {
					result = _table_dockinputeditor;
				}
				break;
			}
			case "tplPop" : {// added by zhangke 场景受理可选功能属性弹出
				if (typeof(_tplPop_table_dockinputeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_tplPop_table_dockinputeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					result.onfocus = function() {
						var dataset = Control.getElementDataset(this);

						var key = dataset.getValue("attrID");

						if (!key) {
							key = dataset.getValue("attrId");
						}

						var result = openDialog(
								SystemContext.appContextPath+"/cs/tpl/component/tplAttrInputCommon.jsp",
								[key, dataset], "", "600px", "400px");
						/*
						 * if(typeof(result)!="undefined"&&result!=null&&result!=""){
						 * this.value=result; }
						 */
						this.blur();
					}
				}// add by wmc -- ?§??×??¨???????ò
				else {
					result = _tplPop_table_dockinputeditor;
				}
				break;
			}
			case "tplPopDown" : {// added by zhangke 场景受理可选功能属性弹出
				if (typeof(_tplPopDown_table_dockinputeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_tplPopDown_table_dockinputeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					result.onfocus = function() {
						var dataset = Control.getElementDataset(this);

						var key = dataset.getValue("attrID");

						if (!key) {
							key = dataset.getValue("attrId");
						}

						var result = openDialog(
								SystemContext.appContextPath+"/cs/tpl/component/tplAttrInputCommon.jsp",
								[key, dataset, window], "", "600px", "400px");
						/*
						 * if(typeof(result)!="undefined"&&result!=null&&result!=""){
						 * this.value=result; }
						 */
						this.blur();
					}
				}// add by wmc -- ?§??×??¨???????ò
				else {
					result = _tplPopDown_table_dockinputeditor;
				}
				break;
			}
			case "pop2" : {
				if (typeof(_table_dockinputeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_dockinputeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					result.onfocus = function() {
						var dataset = Control.getElementDataset(this);
						var dataSetId = dataset.getId();
						var attrCode = dataset.getValue("attrCode");
						var attrId = dataset.getValue("attrID");
						var attrValue = this.value;

						var f = attrCode + "_onPopup";

						if (window[f] != undefined) {
							var res = window[f](dataSetId, attrCode, attrValue);
						}

						if (typeof(res) != "undefined" && res != null
								&& res != "") {
							this.value = res;
						}

						this.blur();
					}
				} else {
					result = _table_dockinputeditor;
				}
				break;
			}
			case "ipeditor" : {
				if (typeof(_table_ipeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_ipeditor class=dockeditor extra=dockeditor tabindex=-1  size='15' maxlength='15' onFocus='' onpaste='checkPaste()' onDrag='checkPaste()' oncut='checkPaste()' onmousemove='checkPaste()'"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					result.onkeydown = function() {
						keydown(this);
					}
					result.onkeypress = function() {
						keypress(this);
					}
					result.onbeforedeactivate = function() {
						return checkip(this);
					}
				} else {
					result = _table_ipeditor;
				}
				break;
			}
			case "date" : {
				if (typeof(_table_dateeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_dateeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					// result.onkeydown=function(){validateDatetime(this,1)}
					result.title = "格式为：9999-12-31"
					result.onbeforedeactivate = function() {
						return validateDatetimeFormat(this, 1);
					}
				} else {
					result = _table_dateeditor;
				}
				break;
			}
			case "time" : {
				if (typeof(_table_timeeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_timeeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					// result.onkeydown=function(){validateDatetime(this,2)}
					result.title = "格式为：23:59:59"
					result.onbeforedeactivate = function() {
						return validateDatetimeFormat(this, 2);
					}
				} else {
					result = _table_timeeditor;
				}
				break;
			}
			case "popDate" : {
				if (typeof(_table_dockdateinputeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_dockdateinputeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					result.onfocus = function() {
						var result = openDialog(SystemContext.appContextPath+"/cs/boa/date.jsp", "",
								"", "320px", "250px");
						if (typeof(result) != "undefined" && result != null
								&& result != "") {
							this.value = result;
						}
						this.blur();
					}
				} else {
					result = _table_dockdateinputeditor;
				}
				break;
			}
			case "datetime" : {
				if (typeof(_table_datetimeeditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_datetimeeditor class=dockeditor extra=dockeditor tabindex=-1"
									+ " style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
					// result.onkeydown=function(){validateDatetime(this,3)}
					result.title = "格式为：9999-12-31 23:59:59"
					result.onbeforedeactivate = function() {
						return validateDatetimeFormat(this, 3);
					}
				} else {
					result = _table_datetimeeditor;
				}
				break;
			}
			default : {
				if (typeof(_table_texteditor) == "undefined") {
					result = document
							.createElement("<INPUT id=_table_texteditor class=dockeditor extra=dockeditor tabindex=-1"
									+
									// " style=\"position: absolute; visibility:
									// hidden\">");
									" style=\"position: absolute; display: none\">");
					document.body.appendChild(result);
					initEditor(result);
				} else {
					result = _table_texteditor;
				}

				var minValue = holder.getAttribute("minValue");
				var maxValue = holder.getAttribute("maxValue");
				var valueMinLen = holder.getAttribute("valueMinLen");
				var valueMaxLen = holder.getAttribute("valueMaxLen");
				var nullable = holder.getAttribute("nullable");
				if (editorType == "double") {
					result.onbeforedeactivate = function() {
						if (this.value != ""
								&& !/^[-\+]?\d+(\.\d+)?$/.test(this.value)) {
							alert("格式不正确，请输入浮点数！");
							this.value = "";
							this.focus();
							event.returnValue = false;
						} else {
							if (!Editor.checkValue(minValue, maxValue,
									valueMinLen, valueMaxLen, this.value)) {
								this.value = "";
								this.focus();
								event.returnValue = false;
							}

						}
						if (nullable == "F" && this.value == "") {
							alert("值不能为空！");
							this.focus();
							event.returnValue = false;
						}

					};
				} else if (editorType == "integer") {
					result.onbeforedeactivate = function() {
						if (this.value != "" && !/^[-\+]?\d+$/.test(this.value)) {
							alert("格式不正确，请输入整数！");
							this.value = "";
							this.focus();
							event.returnValue = false;
						} else {
							if (!Editor.checkValue(minValue, maxValue,
									valueMinLen, valueMaxLen, this.value)) {
								this.value = "";
								this.focus();
								event.returnValue = false;
							}
						}
						if (nullable == "F" && this.value == "") {
							alert("值不能为空！");
							this.focus();
							event.returnValue = false;
						}
					};
				} else if (editorType == "number") {// 数字输入
					result.onbeforedeactivate = function() {
						if (this.value != "" && !/^\d+$/.test(this.value)) {
							alert("格式不正确，请输入数字！");
							this.value = "";
							this.focus();
							event.returnValue = false;
						} else {
							if (!Editor.checkValue(minValue, maxValue,
									valueMinLen, valueMaxLen, this.value)) {
								this.value = "";
								this.focus();
								event.returnValue = false;
							}
						}
						if (nullable == "F" && this.value == "") {
							alert("值不能为空！");
							this.focus();
							event.returnValue = false;
						}
					};
				} else {
					var checkRule = holder.getAttribute("checkRule");
					var checkRuleType = holder.getAttribute("checkRuleType");
					var checkRuleHint = holder.getAttribute("checkRuleHint");

					result.onbeforedeactivate = function() {
						if (!Editor.checkValueByRule(checkRule, checkRuleType,
								checkRuleHint, this.value)) {
							this.value = "";
							this.focus();
							event.returnValue = false;
						}
						if (nullable == "F" && this.value == "") {
							alert("值不能为空！");
							this.focus();
							event.returnValue = false;
						}
					};
				}
				break;
			}
		}

		return result;
	},

	checkValue : function(minValue, maxValue, valueMinLen, valueMaxLen, value) {
		if (value == null || value == "")
			return true;
		if (minValue != null && minValue != "") {
			if (parseFloat(value) < parseFloat(minValue)) {
				alert("格式不正确，值不能小于 " + minValue);
				return false;
			}
		}
		if (maxValue != null && maxValue != "") {
			if (parseFloat(value) > parseFloat(maxValue)) {
				alert("格式不正确，值不能大于 " + maxValue);
				return false;
			}
		}
		if (valueMinLen != null && valueMinLen != "") {
			if (value.length < parseFloat(valueMinLen)) {
				alert("格式不正确，值的长度不能小于 " + valueMinLen);
				return false;
			}
		}
		if (valueMaxLen != null && valueMaxLen != "") {
			if (value.length > valueMaxLen) {
				alert("格式不正确，值的长度不能大于 " + valueMaxLen);
				return false;
			}
		}
		return true;
	},
	checkValueByRule : function(rule, ruleType, ruleHint, value) {
		if (value == null || value == "" || ruleType == null || ruleType == "")
			return true;

		if (ruleType == "1") {// 正则表达式校验
			if (rule == null || rule == "")
				return true;
			else {
				var rec = new RegExp(rule);
				if (rec.exec(value) == null) {
					alert("数据错误，" + ruleHint);
					return false;
				}
			}
		} else {// 其他的以后支持
			return true;
		}
		return true;
	},
	initDockEditor : function() {
		var result = null;

		result = document
				.createElement("<TEXTAREA id=_table_textarea class=dockeditor extra=dockeditor tabindex=-1"
						+
						// " style=\"position: absolute; visibility:
						// hidden\"></TEXTAREA>");
						" style=\"position: absolute; display: none\"></TEXTAREA>");
		document.body.appendChild(result);
		initEditor(result);
		result = null;

		result = document
				.createElement("<INPUT id=_table_checkbox type=checkbox hidefocus=false class=dockeditor extra=dockeditor tabindex=-1"
						+
						// " style=\"position: absolute; visibility: hidden;
						// background-color: window;\">");
						" style=\"position: absolute; display: none; background-color: window;\">");
		document.body.appendChild(result);
		initEditor(result);
		result = null;

		result = document
				.createElement("<INPUT id=_table_texteditor class=dockeditor extra=dockeditor tabindex=-1"
						+
						// " style=\"position: absolute; visibility:
						// hidden\">");
						" style=\"position: absolute; display: none\">");
		document.body.appendChild(result);
		initEditor(result);
		result = null;

		result = document
				.createElement("<INPUT id=_popup_texteditor class=dockeditor extra=dockeditor tabindex=-1"
						+ " style=\"position: absolute; display: none\">");
		result.onblur = function() {
			this.style.display = "none";
		};
		document.body.appendChild(result);
		initEditor(result);
		result.onkeydown = function() {
			event.cancelBubble = true;
			return false;
		};
		result.onpaste = function() {
			event.returnValue = false;
		};
		result.oncut = function() {
			event.returnValue = false;
		}
		result = null;

	},

	setFocusTableCell : function(table, rowIndex, cellIndex) {
		_rowIndex = rowIndex;
		_cellIndex = cellIndex;
		if (_rowIndex == -1)
			_rowIndex = table.activeRowIndex;
		if (_cellIndex == -1)
			_cellIndex = table.activeCellIndex;
		var index = Datatable.checkTableCellIndex(table, _rowIndex, _cellIndex);
		table.rows[index[0]].cells[index[1]].focus();
	},

	isEmptyRow : function(row) {
		function getTableRowState(row) {
			var record = row.record;
			if (record)
				return record.recordstate
			else
				return "";
		}

		return (getTableRowState(row) == "new" && !getTableRowModified(row));
	},
	// 检查节点和所有的父节点，是否有隐藏的元素
	checkElementInHidden : function(element) {
		if (typeof(element.style.visibility) != "undefined"
				&& ("hidden" == element.style.visibility || "none" == element.style.display))
			return true;

		if (typeof(element.parentElement) != "undefined"
				&& element.parentElement.nodeName != "BODY") {
			return Editor.checkElementInHidden(element.parentElement);
		} else {
			return false;
		}
	}
}
// 将html元素初始化为editor组件。
function initEditor(editor) {

	editor.getKeyValue = Editor.getKeyValue;
	editor.getDataType = Editor.getDataType;
	editor.isReadOnly = Editor.isReadOnly;
	editor.getDropDown = Editor.getDropDown;

	editor.onkeypress = Editor.onkeypress;
	editor.onpropertychange = Editor.onpropertychange;
	editor.onkeydown = Document.control_onkeydown;
	editor.setReadOnly = Editor.setReadOnly;

	Control.initElementDataset(editor);

	var field = Control.getElementField(editor);

	if (field && !editor.dropDown && (field.dropDown != "")) {
		editor.dropDown = field.dropDown;
	}

	if (((editor.extra == "editor") && editor.dropDown && !editor.readOnly)
			|| (field && (field.dataType == "date")
					&& (editor.extra == "editor") && !editor.readOnly)) {
		editor.style.background = "url(" + path_prefix
				+ "public/skins/bsn/downdot.gif) top right no-repeat white";
		editor.style.cursor = "hand";
	}

	editor.onmousedown = function() {
		if (!editor.readOnly)
			return Dropdown.btn_onmousedown2(this);
	};

	editor.window = window;

	editor.initialized = true;
}
